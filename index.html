<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ChordPro Viewer — Full Tag + PDF</title>
<style>
  :root{--bg:#f6f8fb;--card:#fff;--muted:#6b7280;--accent:#1f6feb}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:18px;background:var(--bg);color:#111}
  .container{max-width:920px;margin:0 auto}
  header h1{margin:0;font-size:20px}
  header p{margin:6px 0 14px;color:var(--muted)}
  textarea{width:100%;min-height:180px;font-family:monospace;padding:10px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .btn{background:var(--accent);color:white;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
  .btn.secondary{background:white;color:var(--accent);border:1px solid rgba(31,111,235,0.14)}
  .meta{margin:12px 0}
  .song-title{font-size:1.5rem;font-weight:700;margin:0}
  .song-sub{color:var(--muted);margin:4px 0 8px}
  .meta-row{display:flex;gap:12px;flex-wrap:wrap;color:var(--muted);font-size:0.95rem}
  .viewer{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 2px 8px rgba(16,24,40,0.04)}
  pre { font-family:monospace; white-space:pre; margin:6px 0; padding:8px; border-radius:6px; background:#ffffff; border:1px solid #eee; line-height:1.45; font-size:15px; }
  .section-label{font-style:italic;color:var(--muted);margin:6px 0;font-size:0.95rem}
  .chorus{border-left:3px solid #e6f0ff;background:#fbfdff;padding:8px;border-radius:6px}
  .bridge{border-left:3px dashed #f7f3e6;background:#fffef9;padding:8px;border-radius:6px}
  .tab pre{background:#0b1220;color:#cfe8ff;overflow:auto}
  .comment{color:var(--muted);font-style:italic;margin:6px 0}
  .unknown-tag{color:#444;font-size:0.92rem;background:#f7f7f7;padding:6px;border-radius:6px;margin:6px 0}
  footer{color:var(--muted);font-size:13px;text-align:center;margin-top:18px}
  @media (max-width:560px){ .song-title{font-size:1.25rem} pre{font-size:14px} }
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ChordPro Viewer — Full Tag + PDF</h1>
      <p class="meta">Paste your ChordPro text below. Supports metadata tags, structural blocks, transpose, and export to PDF/Print.</p>
    </header>

    <div style="margin-bottom:12px">
      <textarea id="source" placeholder="{title: Song}\n{artist: Someone}\n[C]Hello [G]world"></textarea>
      <div class="controls" style="margin-top:8px">
        <button id="loadExample" class="btn secondary">Load Example</button>
        <button id="render" class="btn">Render</button>
        <button id="exportPdf" class="btn secondary">Export PDF / Print</button>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button id="transposeDown" class="btn secondary">Transpose −</button>
          <span id="transposeVal" style="align-self:center">0</span>
          <button id="transposeUp" class="btn secondary">Transpose +</button>
        </div>
      </div>
    </div>

    <div id="outputArea" class="viewer"></div>

    <footer>
      Host on GitHub Pages or embed via iframe into Google Sites.
    </footer>
  </div>

<script>
const NOTES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const flatToSharp = { 'Db':'C#', 'Eb':'D#', 'Gb':'F#', 'Ab':'G#', 'Bb':'A#' };
let transposeSteps = 0;

function esc(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function transposeChordToken(token, steps){
  const parts = token.split('/');
  const main = parts[0], bass = parts[1];
  const transSingle = (ch) => {
    const m = ch.match(/^([A-G])([#b])?(.*)$/); if(!m) return ch;
    let [, root, acc, rest] = m;
    let full = root + (acc||''); if(flatToSharp[full]) full=flatToSharp[full];
    let idx = NOTES.indexOf(full); if(idx==-1) return ch;
    let ni = (idx+steps)%12; if(ni<0) ni+=12; return NOTES[ni]+(rest||'');
  };
  return bass ? transSingle(main)+'/'+transSingle(bass) : transSingle(main);
}

function applyTransposeToText(text, steps){
  return text.replace(/\[([^\]]+)\]/g, (_, chordText) => {
    const tokens = chordText.split(/\s+/).map(t=>t.trim()).filter(Boolean);
    const trans = tokens.map(t=>transposeChordToken(t, steps)).join(' ');
    return '['+trans+']';
  });
}

function renderLineTwoRow(line){
  let chordLine='', lyricLine='', inChord=false, chordBuf='';
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='['){inChord=true;chordBuf='';}
    else if(ch===']'){inChord=false;
      const pad=lyricLine.length-chordLine.length;
      if(pad>0) chordLine+=' '.repeat(pad);
      chordLine+=chordBuf;
    } else if(inChord) chordBuf+=ch;
    else lyricLine+=ch;
  }
  if(chordLine.trim()) return `<pre>${esc(chordLine)}\n${esc(lyricLine)}</pre>`;
  else if(lyricLine.trim()) return `<pre>${esc(lyricLine)}</pre>`;
  else return `<div style="height:8px"></div>`;
}

function parseChordPro(text){
  const lines=text.replace(/\r/g,'').split('\n');
  const meta={}; const otherTags={}; let outputParts=[]; let blockState={type:null}; const blockStack=[];
  function openBlock(type){
    blockState.type=type; blockStack.push(type);
    if(type==='chorus') outputParts.push('<div class="chorus"><div class="section-label">Chorus</div>');
    else if(type==='bridge') outputParts.push('<div class="bridge"><div class="section-label">Bridge</div>');
    else if(type==='tab') outputParts.push('<div class="tab">');
    else if(type==='comment_box') outputParts.push('<div class="comment" style="border:1px solid #eee;padding:8px;background:#fff">');
  }
  function closeBlock(){ const top=blockStack.pop(); if(!top) return;
    if(top==='chorus'||top==='bridge'||top==='tab'||top==='comment_box') outputParts.push('</div>');
    blockState.type=blockStack[blockStack.length-1]||null;
  }

  for(let rawLine of lines){
    const line=rawLine.trimEnd();
    const tagMatchKV=line.match(/^\{([^:}]+):\s*(.*?)\}$/);
    const tagMatchToken=line.match(/^\{([a-zA-Z0-9_\-]+)\}$/);

    if(tagMatchKV){
      const tag=tagMatchKV[1].toLowerCase(), val=tagMatchKV[2];
      if(['title','subtitle','artist','album','composer','lyricist','capo','key','time','tempo','language','duration','arranger'].includes(tag)) meta[tag]=val;
      else if(['comment','comment_italic','comment_box'].includes(tag)){
        if(tag==='comment_italic') outputParts.push(`<div class="comment" style="font-style:italic">${esc(val)}</div>`);
        else outputParts.push(`<div class="comment">${esc(val)}</div>`);
      } else otherTags[tag]=val;
      continue;
    } else if(tagMatchToken){
      const token=tagMatchToken[1].toLowerCase();
      if(['start_of_chorus','soc','start_chorus'].includes(token)){openBlock('chorus'); continue;}
      if(['end_of_chorus','eoc','end_chorus'].includes(token)){closeBlock(); continue;}
      if(['start_of_bridge','start_bridge'].includes(token)){openBlock('bridge'); continue;}
      if(['end_of_bridge','end_bridge'].includes(token)){closeBlock(); continue;}
      if(['start_of_tab','start_tab'].includes(token)){openBlock('tab'); continue;}
