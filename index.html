<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChordPro Viewer</title>
<style>
body { font-family: Arial, sans-serif; margin: 2em; background:#fafafa; }
textarea { width:100%; height:200px; font-family:monospace; }
button { margin:5px; }
pre {
  font-family: monospace;
  white-space: pre;
  background:#fff;
  padding:0.6em;
  border:1px solid #ccc;
  border-radius:6px;
  line-height:1.4em;
  font-size:16px;
}
</style>
</head>
<body>
<h2>ChordPro Viewer</h2>
<textarea id="input" placeholder="Paste your ChordPro text here..."></textarea><br>
<button onclick="loadExample()">Load Example</button>
<button onclick="render()">Render</button>
<button onclick="transpose(-1)">Transpose âˆ’</button>
<button onclick="transpose(1)">Transpose +</button>
<hr>
<div id="output"></div>

<script>
function processChordPro(text) {
  const lines = text.split('\n');
  let html = '';
  for (let line of lines) {
    if (line.trim().startsWith('{')) continue; // skip directives
    let chordLine = '';
    let lyricLine = '';
    let chordOpen = false;
    let chord = '';
    for (let i = 0; i < line.length; i++) {
      const char = line[i];
      if (char === '[') {
        chordOpen = true; chord = '';
      } else if (char === ']') {
        chordOpen = false;
        const spaces = lyricLine.length - chordLine.length;
        if (spaces > 0) chordLine += ' '.repeat(spaces);
        chordLine += chord;
      } else {
        if (chordOpen) chord += char;
        else lyricLine += char;
      }
    }
    if (chordLine.trim() === '') html += `<pre>${lyricLine}</pre>`;
    else html += `<pre>${chordLine}\n${lyricLine}</pre>`;
  }
  return html;
}

// --- Transpose logic ---
let semitoneShift = 0;
const notes = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];

function transpose(delta) {
  semitoneShift += delta;
  render();
}

function transposeChord(chord) {
  const regex = /^([A-G])(#|b)?(.*)$/;
  const match = chord.match(regex);
  if (!match) return chord;
  let [_, root, accidental, rest] = match;
  let index = notes.indexOf(root + (accidental || ''));
  if (index < 0) {
    // handle flats
    if (accidental === 'b') {
      const flatToSharp = {'Db':'C#','Eb':'D#','Gb':'F#','Ab':'G#','Bb':'A#'};
      const key = root + 'b';
      if (flatToSharp[key]) index = notes.indexOf(flatToSharp[key]);
    }
  }
  if (index < 0) return chord;
  let newIndex = (index + semitoneShift + 12) % 12;
  return notes[newIndex] + rest;
}

function render() {
  let txt = document.getElementById('input').value;
  txt = txt.replace(/\[([A-G][#b]?[^\]]*)\]/g, (_, chord) => `[${transposeChord(chord)}]`);
  document.getElementById('output').innerHTML = processChordPro(txt);
}

function loadExample() {
  document.getElementById('input').value =
`{title: Amazing Grace}
[C]Amazing [G]grace, how [C]sweet the [F]sound
That [C]saved a [G]wretch like [C]me
I [C]once was [F]lost, but [C]now am [G]found
Was [C]blind but [G]now I [C]see`;
}
</script>
</body>
</html>
