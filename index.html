<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ChordPro Viewer — Music Sheet Style (Key dropdown)</title>
<style>
  :root{
    --page-bg:#fbfbfb; --card-bg:#ffffff; --muted:#6b7280;
    --accent:#1f6feb; --accent-quiet:#e6f0ff;
  }
  html,body{height:100%;margin:0;background:var(--page-bg);font-family:Georgia, "Times New Roman", serif;color:#111}
  .wrap{max-width:920px;margin:28px auto;padding:18px}
  header h1{margin:0;font-size:28px}
  header p{margin:6px 0 18px;color:var(--muted);font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif}

  .card{background:var(--card-bg);border-radius:10px;padding:14px;box-shadow:0 2px 8px rgba(16,24,40,0.04);margin-bottom:14px}
  textarea#source{width:100%;min-height:210px;padding:12px;border-radius:6px;border:1px solid #e8eefc;box-sizing:border-box;font-family:monospace;font-size:14px;line-height:1.4;color:#111}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;align-items:center}
  .btn{
    background:transparent;border:1px solid var(--accent);color:var(--accent);padding:8px 12px;border-radius:8px;cursor:pointer;font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  }
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .btn.ghost{background:transparent;border:1px solid #d6dbe8;color:#234}
  .controls .right{margin-left:auto;display:flex;gap:8px;align-items:center}

  /* transpose select styling */
  select#keySelect{padding:8px 10px;border-radius:8px;border:1px solid #dfe7fb;background:#fff;color:#111;font-weight:600}

  .viewer{background:var(--card-bg);padding:18px;border-radius:10px;box-shadow:0 2px 8px rgba(16,24,40,0.04)}
  .song-meta{margin-bottom:12px}
  .title{font-family:"Palatino Linotype","Book Antiqua", Palatino, Georgia, serif;font-size:28px;font-weight:700;margin:0}
  .subtitle{font-style:italic;color:var(--muted);margin-top:4px;margin-bottom:6px}
  .meta-row{font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;color:var(--muted);font-size:0.95rem}
  .music-block{margin:12px 0}

  pre { font-family:"Courier New", Courier, monospace; white-space:pre; margin:6px 0; padding:4px 6px; border-radius:4px; background:#fff; border:1px solid #eee; line-height:1.45; font-size:15px; }
  .section-label{font-style:italic;color:var(--muted);margin:6px 0;font-size:0.95rem}
  .chorus{border-left:3px solid var(--accent-quiet);background:#fcfeff;padding:8px;border-radius:6px}
  .bridge{border-left:3px dashed #f7f3e6;background:#fffef9;padding:8px;border-radius:6px}
  .tab pre{background:#0b1220;color:#cfe8ff;overflow:auto}
  .comment{color:var(--muted);font-style:italic;margin:6px 0;padding-left:6px;border-left:2px solid #f0f0f0}

  .chord-strong{font-weight:700} /* bold chords */

  .hint{font-size:13px;color:var(--muted);margin-top:6px;font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif}
  footer{margin-top:12px;color:var(--muted);font-size:13px;text-align:center}

  /* hide loadExample and render buttons (keep JS intact) */
  #loadExample,
  #render { display: none !important; }

  /* Customize output font style and size (Option 1) */
  .viewer {
    font-family: "Palatino Linotype", "Book Antiqua", Palatino, Georgia, serif;
    font-size: 18px;
    line-height: 1.6;
  }
  .viewer pre {
    font-family: "Courier New", Courier, monospace;
    font-size: 16px;
    line-height: 1.5;
  }

  @media print {
    body{background:white}
    .wrap{margin:10mm auto;padding:0}
    .controls, .no-print{display:none !important}
    .viewer{box-shadow:none;padding:0;border-radius:0}
    pre{font-size:12px}
    .title{font-size:22px}

    /* ✅ Two-column print layout */
    .viewer {
      column-count: 2;
      column-gap: 20mm;
    }
    .music-block,
    .song-meta,
    .section-label,
    pre,
    .chorus,
    .bridge,
    .tab,
    .comment {
      break-inside: avoid;
    }
  }

  @media (max-width:620px){
    .title{font-size:20px}
    pre{font-size:13px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ChordPro Viewer</h1>
      <p>Music-sheet style viewer with full tag support, transpose by key (major/minor), PDF export, download and share link.</p>
    </header>

    <div class="card">
      <label for="source" style="display:block;font-weight:600;margin-bottom:8px">ChordPro source</label>
      <textarea id="source" placeholder="{title: Song}\n{artist: Someone}\n[C]Hello [G]world"></textarea>

      <div class="controls no-print" style="margin-top:10px">
        <button id="loadExample" class="btn ghost">Load example</button>
        <button id="render" class="btn primary">Render</button>
        <button id="downloadCho" class="btn">Download .cho</button>
        <button id="shareLink" class="btn">Share Link</button>
        <button id="exportPdf" class="btn">Export PDF / Print</button>

        <div class="right">
          <label for="keySelect" style="font-weight:600;margin-right:6px;color:#333">Select Key:</label>
          <select id="keySelect" aria-label="Transpose to key" title="Transpose to key">
            <option value="">(original)</option>
          </select>
        </div>
      </div>

      <div class="hint">Tip: Select a target key to transpose the song. The Share Link copies a URL that loads the song into the editor and viewer.</div>
    </div>

    <div id="outputArea" class="viewer card" aria-live="polite"></div>

    <footer>
      ChordPro Viewer by Oscar Reyes Tapia — host on GitHub Pages or embed via iframe.
    </footer>
  </div>

<script>
/* Full ChordPro viewer with key dropdown transpose (major + minor) and bold chords above lyrics */
const MAJOR_KEYS = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const MINOR_SUFFIX = 'm';
const NOTES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const FLAT_EQ = { Db:'C#', Eb:'D#', Gb:'F#', Ab:'G#', Bb:'A#' };
let transposeSteps = 0;
let songOriginalKey = null;

function esc(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function transposeChordToken(token, steps){
  const parts = token.split('/');
  const main = parts[0], bass = parts[1];
  const transSingle = (ch)=>{
    const m = ch.match(/^([A-G])([#b])?(.*)$/);
    if(!m) return ch;
    let [, root, acc, rest] = m;
    let full=root+(acc||'');
    if(FLAT_EQ[full]) full=FLAT_EQ[full];
    let idx=NOTES.indexOf(full);
    if(idx===-1) return ch;
    let ni=(idx+steps)%12; if(ni<0)ni+=12;
    return NOTES[ni]+(rest||'');
  };
  return bass?(transSingle(main)+'/'+transSingle(bass)):transSingle(main);
}

function applyTransposeToText(text, steps){
  return text.replace(/\[([^\]]+)\]/g,(_,ch)=>'['+ch.split(/\s+/).filter(Boolean).map(t=>transposeChordToken(t,steps)).join(' ')+']');
}

function renderLineTwoRow(line){
  let lyric='', chords=[], cacc='', inch=false, clen=0;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='['){inch=true;cacc='';}
    else if(ch===']'){inch=false;const pad=lyric.length-clen;if(pad>0)chords.push({type:'space',len:pad});chords.push({type:'chord',text:cacc});clen+=(pad>0?pad:0)+cacc.length;}
    else if(inch){cacc+=ch;}
    else{lyric+=ch;}
  }
  let chordHtml='';
  for(const seg of chords){chordHtml+=seg.type==='space'?' '.repeat(seg.len):`<span class="chord-strong">${esc(seg.text)}</span>`;}
  if(chordHtml.trim())return `<pre>${chordHtml}\n${esc(lyric)}</pre>`;
  else if(lyric.trim())return `<pre>${esc(lyric)}</pre>`;
  return '<div style="height:8px"></div>';
}

function parseChordPro(text){
  const lines=text.replace(/\r/g,'').split('\n');
  const meta={},other={},parts=[],stack=[];
  let btype=null;
  const open=t=>{stack.push(t);btype=t;parts.push(`<div class="${t}"><div class="section-label">${t.charAt(0).toUpperCase()+t.slice(1)}</div>`);}
  const close=()=>{if(!stack.length)return;const t=stack.pop();parts.push('</div>');btype=stack[stack.length-1]||null;}
  for(const raw of lines){
    const line=raw.trimEnd();
    const kv=line.match(/^\{([^:}]+):\s*(.*?)\}$/);
    const tk=line.match(/^\{([a-zA-Z0-9_\-]+)\}$/);
    if(kv){
      const tag=kv[1].toLowerCase(),val=kv[2];
      if(['title','subtitle','artist','album','key','capo','tempo','time'].includes(tag))meta[tag]=val;
      else parts.push(`<div class="comment">${esc(val)}</div>`);
      continue;
    } else if(tk){
      const t=tk[1].toLowerCase();
      if(['start_of_chorus','soc'].includes(t)){open('chorus');continue;}
      if(['end_of_chorus','eoc'].includes(t)){close();continue;}
      if(['start_of_bridge'].includes(t)){open('bridge');continue;}
      if(['end_of_bridge'].includes(t)){close();continue;}
    }
    if(line.trim()===''){parts.push('<div style="height:10px"></div>');continue;}
    parts.push(renderLineTwoRow(line));
  }
  while(stack.length)close();
  let metaHtml='<div class="song-meta">';
  if(meta.title)metaHtml+=`<div class="title">${esc(meta.title)}</div>`;
  if(meta.subtitle)metaHtml+=`<div class="subtitle">${esc(meta.subtitle)}</div>`;
  if(meta.artist)metaHtml+=`<div class="meta-row">Artist: ${esc(meta.artist)}</div>`;
  if(meta.key)metaHtml+=`<div class="meta-row">Key: ${esc(meta.key)}</div>`;
  metaHtml+='</div>';
  return metaHtml+parts.join('\n');
}

function normalizeKey(k){if(!k)return null;k=k.trim();const m=k.match(/^([A-G])([#b]?)(m?)$/i);if(!m)return null;let root=m[1].toUpperCase(),acc=m[2]||'',min=m[3]?'m':'';let full=root+acc;if(FLAT_EQ[full])full=FLAT_EQ[full];return full+min;}
function computeSemitoneDiff(a,b){const nf=normalizeKey(a),nt=normalizeKey(b);if(!nf||!nt)return 0;const i1=NOTES.indexOf(nf.replace(/m$/,'')),i2=NOTES.indexOf(nt.replace(/m$/,''));let d=i2-i1;if(d>6)d-=12;if(d<-6)d+=12;return d;}

function fillKeySelect(){
  const s=document.getElementById('keySelect');
  s.innerHTML='<option value="">(original)</option>';
  for(const k of MAJOR_KEYS){const o=document.createElement('option');o.value=k;o.textContent=k;s.appendChild(o);}
  const sep=document.createElement('option');sep.disabled=true;sep.textContent='── minor keys ──';s.appendChild(sep);
  for(const k of MAJOR_KEYS){const o=document.createElement('option');o.value=k+'m';o.textContent=k+'m';s.appendChild(o);}
}

function updateKeySelect(orig){
  const s=document.getElementById('keySelect');if(!s.options.length)fillKeySelect();if(!orig)return;
  const nk=normalizeKey(orig);if(!nk)return;
  for(const o of s.options){if(o.value.toLowerCase()===nk.toLowerCase()){if(s.value==='')s.value=o.value;return;}}
}

function render(){
  const raw=document.getElementById('source').value||'';
  const m=raw.match(/\{key:\s*([A-G][#b]?m?)\s*\}/i);
  songOriginalKey=m?m[1].replace(/\s+/g,''):null;
  updateKeySelect(songOriginalKey);
  const sel=document.getElementById('keySelect').value;
  transposeSteps=sel&&songOriginalKey?computeSemitoneDiff(songOriginalKey,sel):0;
  const html=parseChordPro(applyTransposeToText(raw,transposeSteps));
  document.getElementById('outputArea').innerHTML=`<div class="music-block">${html}</div>`;
}

document.getElementById('keySelect').addEventListener('change',e=>{
  const t=e.target.value;
  transposeSteps=(!t||!songOriginalKey)?0:computeSemitoneDiff(songOriginalKey,t);
  render();
});

document.getElementById('downloadCho').addEventListener('click',()=>{
  const text=document.getElementById('source').value||'';
  let fn='song.cho';const m=text.match(/^\s*\{title:\s*(.+?)\}/im);
  if(m&&m[1])fn=m[1].trim().toLowerCase().replace(/[^\w\- ]+/g,'').replace(/\s+/g,'_')+'.cho';
  const blob=new Blob([text],{type:'text/plain;charset=utf-8'});
  const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=fn;document.body.appendChild(a);a.click();
  setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},200);
});

function encodeForUrl(s){try{return btoa(unescape(encodeURIComponent(s)));}catch(e){return encodeURIComponent(s);}}
function decodeFromUrl(s){try{return decodeURIComponent(escape(atob(s)));}catch(e){try{return decodeURIComponent(s);}catch(e2){return s;}}}

document.getElementById('shareLink').addEventListener('click',async()=>{
  const text=document.getElementById('source').value||'';const enc=encodeForUrl(text);
  const url=location.origin+location.pathname+'?song='+enc;
  try{await navigator.clipboard.writeText(url);
    const b=document.getElementById('shareLink');const p=b.textContent;b.textContent='Link copied ✓';
    setTimeout(()=>{b.textContent=p;},1500);
  }catch(e){prompt('Copy this link:',url);}
});

function loadFromQuery(){
  const p=new URLSearchParams(location.search);
  if(p.has('song')){const dec=decodeFromUrl(p.get('song'));document.getElementById('source').value=dec;transposeSteps=0;render();}
}

/* --- Export to PDF / Print (now 2-column) --- */
document.getElementById('exportPdf').addEventListener('click',()=>{
  const content=document.getElementById('outputArea').innerHTML;
  const title=(document.querySelector('.title')&&document.querySelector('.title').textContent)||'ChordPro Song';
  const w=window.open('','_blank');
  const css=`
    body{font-family:Georgia,"Times New Roman",serif;margin:20mm;color:#111;background:#fff;}
    .title{font-size:22px;font-weight:700;margin-bottom:6px}
    .subtitle{font-style:italic;color:#666;margin-bottom:8px}
    .meta-row{color:#666;margin-bottom:8px}
    pre{font-family:"Courier New",Courier,monospace;font-size:13px;line-height:1.35;margin:6px 0}
    .chorus,.bridge,.tab,.comment{background:#f9f9f9;padding:6px;margin:6px 0;border-radius:4px;}
    .section-label{font-style:italic;color:#666;margin:4px 0}

    /* two-column layout */
    .viewer{column-count:2;column-gap:20mm;}
    .music-block,.song-meta,.section-label,pre,.chorus,.bridge,.tab,.comment{break-inside:avoid;}

    @media print{body{margin:12mm}pre{font-size:11px}}
  `;
  w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>${esc(title)}</title><style>${css}</style></head><body><div class="viewer">${content}</div></body></html>`);
  w.document.close();w.focus();setTimeout(()=>{w.print();},250);
});

fillKeySelect();loadFromQuery();render();
</script>
</body>
</html>
