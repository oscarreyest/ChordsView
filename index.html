<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ChordPro Viewer — Music Sheet Style</title>
<style>
  :root{
    --page-bg:#fbfbfb; --card-bg:#ffffff; --muted:#6b7280;
    --accent:#1f6feb; --accent-quiet:#e6f0ff;
  }
  html,body{height:100%;margin:0;background:var(--page-bg);font-family:Georgia,"Times New Roman",serif;color:#111}
  .wrap{max-width:920px;margin:28px auto;padding:18px}
  header h1{margin:0;font-size:28px}
  header p{margin:6px 0 18px;color:var(--muted);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}
  .card{background:var(--card-bg);border-radius:10px;padding:14px;box-shadow:0 2px 8px rgba(16,24,40,0.04);margin-bottom:14px}
  textarea#source{width:100%;min-height:210px;padding:12px;border-radius:6px;border:1px solid #e8eefc;box-sizing:border-box;font-family:monospace;font-size:14px;line-height:1.4;color:#111}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;align-items:center}
  .btn{background:transparent;border:1px solid var(--accent);color:var(--accent);padding:8px 12px;border-radius:8px;cursor:pointer;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .btn.ghost{background:transparent;border:1px solid #d6dbe8;color:#234}
  .controls .right{margin-left:auto;display:flex;gap:8px;align-items:center}
  select#keySelect{padding:8px 10px;border-radius:8px;border:1px solid #dfe7fb;background:#fff;color:#111;font-weight:600}
  .viewer{background:var(--card-bg);padding:18px;border-radius:10px;box-shadow:0 2px 8px rgba(16,24,40,0.04)}
  .song-meta{margin-bottom:12px}
  .title{font-family:"Palatino Linotype","Book Antiqua",Palatino,Georgia,serif;font-size:28px;font-weight:700;margin:0}
  .subtitle{font-style:italic;color:var(--muted);margin-top:4px;margin-bottom:6px}
  .meta-row{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;color:var(--muted);font-size:0.95rem}
  pre{font-family:"Courier New",Courier,monospace;white-space:pre;margin:6px 0;padding:4px 6px;border-radius:4px;background:#fff;border:1px solid #eee;line-height:1.45;font-size:15px}
  .chorus{border-left:3px solid var(--accent-quiet);background:#fcfeff;padding:8px;border-radius:6px}
  .bridge{border-left:3px dashed #f7f3e6;background:#fffef9;padding:8px;border-radius:6px}
  .comment{color:var(--muted);font-style:italic;margin:6px 0;padding-left:6px;border-left:2px solid #f0f0f0}
  .comment-box{border:1px dashed #bbb;padding:6px 8px;border-radius:6px;color:#444;margin:8px 0;background:#f9fafb;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;font-style:italic}
  .chord-strong{font-weight:700}
  footer{margin-top:12px;color:var(--muted);font-size:13px;text-align:center}
  @media print{body{background:white}.wrap{margin:10mm auto;padding:0}.controls,.no-print{display:none!important}.viewer{box-shadow:none;padding:0;border-radius:0}pre{font-size:12px}.title{font-size:22px}}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ChordPro Viewer</h1>
      <p>Music-sheet style viewer with transpose, share link, PDF export, comments, and full tag support.</p>
    </header>

    <div class="card">
      <label for="source" style="display:block;font-weight:600;margin-bottom:8px">ChordPro source</label>
      <textarea id="source" placeholder="{title: Song}\n{artist: Someone}\n{key: C}\n[C]Hello [G]world"></textarea>

      <div class="controls no-print">
        <button id="loadExample" class="btn ghost">Load example</button>
        <button id="render" class="btn primary">Render</button>
        <button id="downloadCho" class="btn">Download .cho</button>
        <button id="shareLink" class="btn">Share Link</button>
        <button id="exportPdf" class="btn">Export PDF / Print</button>
        <div class="right">
          <label for="keySelect" style="font-weight:600;margin-right:6px;color:#333">Transpose to:</label>
          <select id="keySelect"><option value="">(original)</option></select>
        </div>
      </div>
    </div>

    <div id="outputArea" class="viewer card" aria-live="polite"></div>

    <footer>
      ChordPro Viewer by Oscar Reyes Tapia — host on GitHub Pages or embed in Google Sites.
    </footer>
  </div>

<script>
const MAJOR_KEYS = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const FLAT_EQ = {Db:'C#',Eb:'D#',Gb:'F#',Ab:'G#',Bb:'A#'};
const NOTES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
let songOriginalKey=null, transposeSteps=0;

function esc(s){return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

function transposeChordToken(token,steps){
  const parts=token.split('/');
  const tSingle=(ch)=>{const m=ch.match(/^([A-G])([#b])?(.*)$/);if(!m)return ch;
  let[,root,acc,rest]=m;let full=root+(acc||'');if(FLAT_EQ[full])full=FLAT_EQ[full];
  let idx=NOTES.indexOf(full);if(idx===-1)return ch;
  let ni=(idx+steps)%12;if(ni<0)ni+=12;return NOTES[ni]+(rest||'');};
  return parts[1]?tSingle(parts[0])+'/'+tSingle(parts[1]):tSingle(parts[0]);
}

function applyTransposeToText(text,steps){
  return text.replace(/\[([^\]]+)\]/g,(_,chords)=>{
    return '['+chords.split(/\s+/).map(c=>transposeChordToken(c,steps)).join(' ')+']';
  });
}

function renderLineTwoRow(line){
  let lyric='',segments=[],acc='',inChord=false,len=0;
  for(let ch of line){
    if(ch==='['){inChord=true;acc='';}
    else if(ch===']'){inChord=false;const pad=lyric.length-len;if(pad>0)segments.push({t:'space',n:pad});
      segments.push({t:'chord',txt:acc});len+=(pad>0?pad:0)+acc.length;}
    else if(inChord)acc+=ch;else lyric+=ch;
  }
  let chordHtml='';
  for(const s of segments){if(s.t==='space')chordHtml+=' '.repeat(s.n);
    else if(s.t==='chord')chordHtml+=`<span class="chord-strong">${esc(s.txt)}</span>`;}
  if(chordHtml.trim())return `<pre>${chordHtml}\n${esc(lyric)}</pre>`;
  else if(lyric.trim())return `<pre>${esc(lyric)}</pre>`;
  else return '<div style="height:8px"></div>';
}

function parseChordPro(text){
  const lines=text.replace(/\r/g,'').split('\n'),meta={},parts=[];
  for(let raw of lines){
    const line=raw.trimEnd();
    const kv=line.match(/^\{([^:}]+):\s*(.*?)\}$/);
    if(kv){
      const tag=kv[1].toLowerCase(),val=kv[2];
      // meta tags
      if(['title','artist','key'].includes(tag)){ meta[tag]=val; continue; }
      // visible tags
      if(tag==='comment' || tag==='comment_italic'){ parts.push(`<div class="comment">${esc(val)}</div>`); continue; }
      if(tag==='comment_box'){ parts.push(`<div class="comment-box">${esc(val)}</div>`); continue; }
      if(tag==='subtitle'){ parts.push(`<div class="subtitle">${esc(val)}</div>`); continue; }
      continue;
    }
    if(!line){parts.push('<div style="height:10px"></div>');continue;}
    parts.push(renderLineTwoRow(line));
  }
  let metaHtml='<div class="song-meta">';
  if(meta.title)metaHtml+=`<div class="title">${esc(meta.title)}</div>`;
  if(meta.subtitle)metaHtml+=`<div class="subtitle">${esc(meta.subtitle)}</div>`;
  if(meta.artist)metaHtml+=`<div class="meta-row">Artist: ${esc(meta.artist)}</div>`;
  if(meta.key)metaHtml+=`<div class="meta-row">Key: ${esc(meta.key)}</div>`;
  metaHtml+='</div>';
  return metaHtml+parts.join('\n');
}

function normalizeKey(k){if(!k)return null;let m=k.trim().match(/^([A-G])([#b]?)(m?)$/i);
  if(!m)return null;let root=m[1].toUpperCase(),acc=m[2]||'',min=m[3]?'m':'';let full=root+acc;if(FLAT_EQ[full])full=FLAT_EQ[full];
  return full+min;}

function computeDiff(from,to){
  const f=normalizeKey(from),t=normalizeKey(to);if(!f||!t)return 0;
  const fr=f.replace(/m$/,''),tr=t.replace(/m$/,'');
  const i1=NOTES.indexOf(fr),i2=NOTES.indexOf(tr);
  let diff=i2-i1;if(diff>6)diff-=12;if(diff<-6)diff+=12;return diff;
}

function fillKeySelect(){
  const s=document.getElementById('keySelect');
  s.innerHTML='<option value="">(original)</option>';
  for(const k of MAJOR_KEYS){s.innerHTML+=`<option value="${k}">${k}</option>`;}
  s.innerHTML+='<option disabled>── minor keys ──</option>';
  for(const k of MAJOR_KEYS){s.innerHTML+=`<option value="${k}m">${k}m</option>`;}
}

function render(){
  const text=document.getElementById('source').value||'';
  const km=text.match(/\{key:\s*([A-G][#b]?m?)\s*\}/i);
  songOriginalKey=km?km[1]:null;
  const sel=document.getElementById('keySelect').value;
  transposeSteps=(sel&&songOriginalKey)?computeDiff(songOriginalKey,sel):0;
  const out=applyTransposeToText(text,transposeSteps);
  document.getElementById('outputArea').innerHTML=parseChordPro(out);
}

document.getElementById('render').onclick=render;

document.getElementById('keySelect').onchange=()=>{render();};

document.getElementById('loadExample').onclick=()=>{
  document.getElementById('source').value=`{title: Amazing Grace}
{artist: John Newton}
{key: G}
{comment: A beloved traditional hymn}
[G]Amazing [C]grace, how [G]sweet the [D]sound
That [G]saved a [C]wretch like [D]me
{comment_box: Play gently, slow tempo}`;
  render();
};

document.getElementById('downloadCho').onclick=()=>{
  const text=document.getElementById('source').value;
  const blob=new Blob([text],{type:'text/plain'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);a.download='song.cho';
  a.click();setTimeout(()=>URL.revokeObjectURL(a.href),200);
};

document.getElementById('shareLink').onclick=async()=>{
  const text=document.getElementById('source').value||'';
  const encoded=btoa(unescape(encodeURIComponent(text)));
  const base=window.location.href.split('?')[0];
  const url=`${base}?song=${encoded}`;
  try{await navigator.clipboard.writeText(url);
    const btn=document.getElementById('shareLink');const old=btn.textContent;
    btn.textContent='Link copied ✓';setTimeout(()=>btn.textContent=old,1500);
  }catch{prompt('Copy this link:',url);}
};

document.getElementById('exportPdf').onclick=()=>{
  const w=window.open('','_blank');
  const c=document.getElementById('outputArea').innerHTML;
  w.document.write(`<!doctype html><html><head><title>ChordPro Song</title>
  <style>body{font-family:Georgia,serif;margin:28px;}pre{font-family:monospace;font-size:13px;} .chord-strong{font-weight:bold}.comment{color:#555;font-style:italic;margin:4px 0}</style>
  </head><body>${c}</body></html>`);
  w.document.close();setTimeout(()=>w.print(),300);
};

function loadFromQuery(){
  const p=new URLSearchParams(location.search);
  if(p.has('song')){
    const dec=decodeURIComponent(escape(atob(p.get('song'))));
    document.getElementById('source').value=dec;
    render();
  }
}

fillKeySelect();
loadFromQuery();
</script>
</body>
</html>
