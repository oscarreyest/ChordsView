<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ChordPro Viewer — Unified Screen & Print (Option 2)</title>
<style>
  :root{
    /* Base palette */
    --page-bg:#f7f8fa; --card-bg:#ffffff; --muted:#6b7280; --accent:#1f6feb;

    /* Screen tints for sections */
    --generic-bg:#f8f9fa;
    --verse-bg:#f3fdf3;
    --chorus-bg:#eef6ff;
    --bridge-bg:#fffbea;
    --intro-bg:#f9f5ff;
    --interlude-bg:#faf5ff;
    --outro-bg:#f8f5f9;

    /* New section tints */
    --medley-bg:#f9f5ff;
    --instrumental-bg:#f3fdfd;
    --solo-bg:#fff8f0;

    /* Accents for badges/lines */
    --generic-ac:#cfd8dc;
    --verse-ac:#81c784;
    --chorus-ac:#64b5f6;
    --bridge-ac:#f6d860;
    --intro-ac:#b39ddb;
    --interlude-ac:#ce93d8;
    --outro-ac:#b39ddb;
    --medley-ac:#ba68c8;
    --instrumental-ac:#4db6ac;
    --solo-ac:#ffb74d;

    /* Typography (auto-scaled by JS) */
    --lyric-size:16px;
    --chord-size:17px;
    --pre-line:1.6;
    --section-title:16px;
    --meta-size:14px;
    --badge-font:12px;
    --title-size:32px;
    --subtitle-size:18px;

    /* Layout */
    --viewer-pad:24px;
    --column-gap:22mm;
    --header-gap:10px;
    --pre-margin:8px;
  }

  html,body{height:100%;margin:0;background:var(--page-bg);font-family:Georgia,"Times New Roman",serif;color:#111}
  .wrap{max-width:900px;margin:28px auto;padding:18px}
  header h1{margin:0 0 4px 0;font-size:28px;font-weight:800}
  header p{margin:0 0 18px 0;color:var(--muted);font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif}

  .card{background:var(--card-bg);border-radius:12px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,.08);margin-bottom:14px}
  textarea#source{width:100%;min-height:200px;border-radius:8px;padding:14px;border:1px solid #e1e4ea;font-family:monospace;font-size:14px;line-height:1.4}

  /* Controls */
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px}
  .btn{padding:8px 14px;border-radius:8px;cursor:pointer;font-family:system-ui;border:1px solid var(--accent);background:#fff;color:var(--accent)}
  .btn.primary{background:var(--accent);color:#fff}
  .controls .right{margin-left:auto;display:flex;align-items:center;gap:8px}
  select#keySelect{padding:8px;border-radius:8px;border:1px solid #bfc6d9;font-weight:600}

  /* Viewer */
  .viewer{background:#fff;border-radius:12px;padding:var(--viewer-pad);box-shadow:0 2px 6px rgba(0,0,0,.06)}
  .title{font-size:var(--title-size);font-weight:800;margin:0 0 4px 0}
  .subtitle{font-size:var(--subtitle-size);font-style:italic;color:var(--muted);margin:0 0 6px 0}
  .meta-row{font-size:var(--meta-size);color:var(--muted);font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif}

  /* Header box & header badges */
  .header-box{border:1px solid #dce2ea;border-radius:12px;padding:14px 16px;margin-bottom:12px}
  .viewer > .header-box{-webkit-column-span:all;column-span:all;width:100%;box-sizing:border-box;}
  .header-content{text-align:center}
  .header-badges{display:flex;justify-content:center;align-items:center;flex-wrap:wrap;gap:10px;margin-top:var(--header-gap);}
  .header-badge{min-width:26px;height:26px;display:flex;align-items:center;justify-content:center;font-size:var(--badge-font);font-weight:800;border-radius:50%;border:2px solid var(--generic-ac);background:#fff;color:#111;padding:0 6px;}
  .header-badge.type-verse{border-color:var(--verse-ac)}
  .header-badge.type-prechorus{border-color:#ffb74d}
  .header-badge.type-chorus{border-color:var(--chorus-ac)}
  .header-badge.type-bridge{border-color:var(--bridge-ac)}
  .header-badge.type-intro{border-color:var(--intro-ac)}
  .header-badge.type-interlude{border-color:var(--interlude-ac)}
  .header-badge.type-outro{border-color:var(--outro-ac)}
  .header-badge.type-medley{border-color:var(--medley-ac)}
  .header-badge.type-instrumental{border-color:var(--instrumental-ac)}
  .header-badge.type-solo{border-color:var(--solo-ac)}
  .header-badge.type-generic{border-color:var(--generic-ac)}

  /* Section boxes */
  .section-box{margin:12px 0!important;border-radius:12px;border:1px solid #dce2ea;background:var(--generic-bg);}
  .section-box.verse{background:var(--verse-bg)}
  .section-box.chorus{background:var(--chorus-bg)}
  .section-box.bridge{background:var(--bridge-bg)}
  .section-box.intro{background:var(--intro-bg)}
  .section-box.interlude{background:var(--interlude-bg)}
  .section-box.outro{background:var(--outro-bg)}
  .section-box.medley{background:var(--medley-bg)}
  .section-box.instrumental{background:var(--instrumental-bg)}
  .section-box.solo{background:var(--solo-bg)}

  .section-head{position:relative;padding:18px 16px 4px 16px;}
  .section-title{margin:8px 0 0 0;font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;font-weight:700;color:#1f6feb;font-size:var(--section-title);}
  .section-badge{position:absolute;top:-14px;left:16px;min-width:26px;height:26px;border-radius:50%;background:#fff;border:2px solid var(--generic-ac);font-size:var(--badge-font);font-weight:800;display:flex;align-items:center;justify-content:center;}
  .section-line{position:absolute;top:0;left:52px;right:16px;height:2px;background:var(--generic-ac);border-radius:3px;}
  .section-box.verse .section-line,.section-box.verse .section-badge{border-color:var(--verse-ac);background:none}
  .section-box.chorus .section-line,.section-box.chorus .section-badge{border-color:var(--chorus-ac);background:none}
  .section-box.bridge .section-line,.section-box.bridge .section-badge{border-color:var(--bridge-ac);background:none}
  .section-box.intro .section-line,.section-box.intro .section-badge{border-color:var(--intro-ac);background:none}
  .section-box.interlude .section-line,.section-box.interlude .section-badge{border-color:var(--interlude-ac);background:none}
  .section-box.outro .section-line,.section-box.outro .section-badge{border-color:var(--outro-ac);background:none}
  .section-box.medley .section-line,.section-box.medley .section-badge{border-color:var(--medley-ac);background:none}
  .section-box.instrumental .section-line,.section-box.instrumental .section-badge{border-color:var(--instrumental-ac);background:none}
  .section-box.solo .section-line,.section-box.solo .section-badge{border-color:var(--solo-ac);background:none}

  pre{font-family:"Courier New",Courier,monospace;white-space:pre;font-size:var(--lyric-size);line-height:1.25!important;margin:2px 0!important;padding:2px 0!important;background:transparent!important;border:none!important;}
  .chord-strong{font-weight:700;font-size:var(--chord-size)}

  .viewer.two-col{column-count:2;column-gap:var(--column-gap);column-fill:auto;}
  .comment{color:var(--muted);font-style:italic;margin:6px 0;padding-left:6px;border-left:2px solid #f0f0f0}
  .comment.box{border-left:4px solid #ccc;background:#f8f8f8;padding:8px;border-radius:6px;font-style:normal;color:#333}
  footer{margin-top:12px;color:var(--muted);font-size:13px;text-align:center}

  @media print{
    body{margin:12mm;background:#fff}
    .controls,.no-print{display:none!important}
    .viewer{box-shadow:none;padding:0}
    @page{size:Letter;margin:12mm;}
    pre{line-height:1.25!important;}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ChordPro Viewer</h1>
      <p>Unified screen/print, badges locked to titles, sections flow across columns, preserves chord alignment.</p>
    </header>

    <div class="card">
      <label for="source" style="display:block;font-weight:600;margin-bottom:8px">ChordPro source</label>
      <textarea id="source" placeholder="{start_of_medley}
[C] Song part 1
{end_of_medley}
{start_of_instrumental}
[C] [G] [Am] [F]
{end_of_instrumental}
{start_of_solo}
[G] riff [C]
{end_of_solo}"></textarea>

      <div class="controls no-print">
        <button id="render" class="btn primary">Render</button>
        <button id="downloadCho" class="btn">Download .cho</button>
        <button id="shareLink" class="btn">Share Link</button>
        <button id="exportPdf" class="btn">Export PDF / Print</button>

        <div class="right">
          <label for="keySelect" style="font-weight:600;margin-right:6px;color:#333">Select Key:</label>
          <select id="keySelect"><option value="">(original)</option></select>
        </div>
      </div>
    </div>

    <div id="outputArea" class="viewer card"></div>

    <footer>ChordPro Viewer — same look on screen and print; badges pinned; sections can flow.</footer>
  </div>

<script>
/* ================== Utilities ================== */
const MAJOR_KEYS=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const NOTES=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const FLAT_EQ={Db:'C#',Eb:'D#',Gb:'F#',Ab:'G#',Bb:'A#'};
let transposeSteps=0,songOriginalKey=null;

const esc=s=>(s??'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

/* Transpose and render logic identical to your Good working version ... */

/* Only difference below: new section recognizers added */
function classifySection(labelGuess, tokenType=null){
  const t=(labelGuess||'').toLowerCase();
  if(tokenType==='chorus')return{type:'chorus',title:labelGuess||'Chorus'};
  if(tokenType==='bridge')return{type:'bridge',title:labelGuess||'Bridge'};
  if(tokenType==='verse') return{type:'verse',title:labelGuess||'Verse'};
  if(tokenType==='intro') return{type:'intro',title:labelGuess||'Intro'};
  if(tokenType==='prechorus')return{type:'prechorus',title:labelGuess||'Pre-Chorus'};
  if(tokenType==='interlude')return{type:'interlude',title:labelGuess||'Interlude'};
  if(tokenType==='outro') return{type:'outro',title:labelGuess||'Outro'};
  if(tokenType==='medley') return{type:'medley',title:labelGuess||'Medley'};
  if(tokenType==='instrumental') return{type:'instrumental',title:labelGuess||'Instrumental'};
  if(tokenType==='solo') return{type:'solo',title:labelGuess||'Solo'};
  if(/medley/i.test(t)) return{type:'medley',title:labelGuess||'Medley'};
  if(/instrumental/i.test(t)) return{type:'instrumental',title:labelGuess||'Instrumental'};
  if(/solo/i.test(t)) return{type:'solo',title:labelGuess||'Solo'};
  return{type:'generic',title:labelGuess||'Section'};
}

function autoBadgeFrom(type,title){
  const m=(title||'').match(/(\d+)/), n=m?m[1]:'';
  switch(type){
    case'verse':return'V'+n;
    case'prechorus':return'Pc';
    case'chorus':return'C';
    case'bridge':return'B';
    case'intro':return'I';
    case'interlude':return'It';
    case'outro':return'O';
    case'medley':return'M';
    case'instrumental':return'Inst';
    case'solo':return'S';
    default:return'';
  }
}

/* Section parsing additions */
function parseChordProBody(text){
  const lines=text.replace(/\r/g,'').split('\n'), parts=[];
  let sectionOpen=false, blockType=null;

  const openSection=(title,type)=>{
    parts.push(`<div class="section-box ${type}"><div class="section-head"><div class="section-line"></div><div class="section-badge">${autoBadgeFrom(type,title)}</div><div class="section-title">${title}</div></div><div class="section-body">`);
    sectionOpen=true;
  };
  const closeSection=()=>{ if(sectionOpen){ parts.push('</div></div>'); sectionOpen=false; } };

  for(const raw of lines){
    const line=raw.trimEnd();
    const token=line.match(/^\{([a-z_]+)\}$/i);
    if(token){
      const t=token[1].toLowerCase();
      if(['start_of_chorus','soc','start_chorus'].includes(t)){ closeSection(); blockType='chorus'; openSection('Chorus','chorus'); continue; }
      if(['start_of_bridge','start_bridge'].includes(t)){ closeSection(); blockType='bridge'; openSection('Bridge','bridge'); continue; }
      if(['start_of_medley','start_medley'].includes(t)){ closeSection(); blockType='medley'; openSection('Medley','medley'); continue; }
      if(['start_of_instrumental','start_instrumental'].includes(t)){ closeSection(); blockType='instrumental'; openSection('Instrumental','instrumental'); continue; }
      if(['start_of_solo','start_solo'].includes(t)){ closeSection(); blockType='solo'; openSection('Solo','solo'); continue; }
      if(['end_of_chorus','end_of_bridge','end_of_medley','end_of_instrumental','end_of_solo'].includes(t)){ closeSection(); blockType=null; continue; }
    }
    if(line.trim()===''){ parts.push('<div style="height:8px"></div>'); continue; }
    if(!sectionOpen) openSection('Section','generic');
    parts.push(`<pre>${esc(line)}</pre>`);
  }
  closeSection();
  return parts.join('');
}

/* ... all other JS from your Good working version stays identical */
</script>
</body>
</html>
