<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Song Chart Editor</title>
<style>
  :root{
    --page-bg:#f7f8fa; --card-bg:#ffffff; --muted:#6b7280; --accent:#1f6feb;
    --verse-ac:#81c784; --chorus-ac:#64b5f6; --bridge-ac:#f6d860;
    --intro-ac:#b39ddb; --interlude-ac:#ce93d8; --outro-ac:#b39ddb; --generic-ac:#cfd8dc;
    --verse-bg:#f3fdf3; --chorus-bg:#eef6ff; --bridge-bg:#fffbea;
    --intro-bg:#f9f5ff; --interlude-bg:#faf5ff; --outro-bg:#f8f5f9; --generic-bg:#f8f9fa;
    --lyric-size:16px; --chord-size:17px; --section-title:16px; --meta-size:14px;
    --badge-font:12px; --title-size:32px; --subtitle-size:18px;
  }
  html,body{height:100%;margin:0;background:var(--page-bg);font-family:Georgia,serif;color:#111}
  .wrap{max-width:900px;margin:28px auto;padding:18px}
  header h1{margin:0 0 4px 0;font-size:28px;font-weight:800;text-align:center}
  header p{margin:0 0 18px 0;color:var(--muted);text-align:center}
  .card{background:var(--card-bg);border-radius:12px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,.08);margin-bottom:14px}
  textarea#source{width:100%;min-height:200px;border-radius:8px;padding:14px;border:1px solid #e1e4ea;font-family:monospace;font-size:14px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px}
  .btn{padding:8px 14px;border-radius:8px;cursor:pointer;font-family:system-ui;border:1px solid var(--accent);background:#fff;color:var(--accent)}
  .btn.primary{background:var(--accent);color:#fff}
  .controls .right{margin-left:auto;display:flex;align-items:center;gap:8px}
  select#keySelect{padding:8px;border-radius:8px;border:1px solid #bfc6d9;font-weight:600}

  /* Viewer */
  .viewer{background:#fff;border-radius:12px;padding:24px;box-shadow:0 2px 6px rgba(0,0,0,.06);display:flex;flex-wrap:wrap;gap:22mm;justify-content:space-between}
  .column{flex:1 1 42%;min-width:360px;max-width:48%;display:flex;flex-direction:column;gap:10px}

  .header-box{text-align:center;margin-bottom:16px;border:1px solid #dce2ea;border-radius:12px;padding:14px 16px}
  .title{font-size:var(--title-size);font-weight:800;margin:0}
  .subtitle{font-size:var(--subtitle-size);font-style:italic;color:var(--muted);margin:0 0 6px 0}
  .meta-row{font-size:var(--meta-size);color:#333;margin:4px 0}
  .meta-inline{display:inline-block;margin:4px 0;color:var(--muted);font-size:var(--meta-size)}

  .header-badges{display:flex;justify-content:center;gap:10px;margin-top:10px;flex-wrap:wrap}
  .header-badge{min-width:26px;height:26px;display:flex;align-items:center;justify-content:center;
    font-size:var(--badge-font);font-weight:800;border-radius:50%;border:2px solid var(--generic-ac);background:#fff;color:#111}
  .header-badge.type-verse{border-color:var(--verse-ac)} .header-badge.type-chorus{border-color:var(--chorus-ac)}
  .header-badge.type-bridge{border-color:var(--bridge-ac)} .header-badge.type-intro{border-color:var(--intro-ac)}
  .header-badge.type-interlude{border-color:var(--interlude-ac)} .header-badge.type-outro{border-color:var(--outro-ac)}

  .section-box{border:1px solid #dce2ea;border-radius:12px;padding:14px 16px;background:var(--generic-bg);position:relative}
  .section-box.verse{background:var(--verse-bg)} .section-box.chorus{background:var(--chorus-bg)}
  .section-box.bridge{background:var(--bridge-bg)} .section-box.intro{background:var(--intro-bg)}
  .section-box.interlude{background:var(--interlude-bg)} .section-box.outro{background:var(--outro-bg)}

  .section-badge{position:absolute;top:-14px;left:16px;min-width:26px;height:26px;border-radius:50%;background:#fff;border:2px solid var(--generic-ac);
    font-size:var(--badge-font);font-weight:800;display:flex;align-items:center;justify-content:center}
  .section-title{margin-top:10px;font-family:system-ui;font-weight:700;color:#1f6feb;font-size:var(--section-title)}
  .section-line{position:absolute;top:0;left:52px;right:16px;height:2px;background:var(--generic-ac);border-radius:3px}
  pre{font-family:"Courier New",monospace;white-space:pre;font-size:var(--lyric-size);line-height:1.6;margin:8px 0;background:#fff;border:1px solid #eee;border-radius:4px;padding:6px}
  .chord-strong{font-weight:700;font-size:var(--chord-size)}

  footer{text-align:center;font-size:13px;color:var(--muted);margin-top:14px}

  @media print{
    body{background:#fff;margin:12mm}
    .controls,.no-print{display:none !important}
    .viewer{box-shadow:none;padding:0}
    @page{size:Letter;margin:12mm}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Song Chart Editor</h1>
      <p>Unified screen/print layout — fits Letter page with two-column auto-fit.</p>
    </header>

    <div class="card">
      <label for="source" style="display:block;font-weight:600;margin-bottom:8px">ChordPro source</label>
      <textarea id="source" placeholder="{start_header}
{title: Tú Eres Digno de Gloria}
{artist: ICZ Worship}
{key: Am}
{time: 4/4}
{tempo: 126}
{comment_box: Key changed to: [Am]}
{section_list: I, V1, C, B}
{end_header}
{comment: Intro}
[F] [G] [F] [G]
..."></textarea>

      <div class="controls no-print">
        <button id="render" class="btn primary">Render</button>
        <button id="exportPdf" class="btn">Export PDF / Print</button>
        <div class="right">
          <label for="keySelect" style="font-weight:600;color:#333">Key:</label>
          <select id="keySelect"><option value="">(original)</option></select>
        </div>
      </div>
    </div>

    <div id="outputArea" class="viewer"></div>

    <footer>
      Printed for ministry use only — do not distribute.<br>
      For use of the Iglesia Bautista Nueva Esperanza Worship Team only.
    </footer>
  </div>

<script>
const MAJOR_KEYS=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const NOTES=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const FLAT_EQ={Db:'C#',Eb:'D#',Gb:'F#',Ab:'G#',Bb:'A#'};
let transposeSteps=0,songOriginalKey=null;
const esc=s=>s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
function transposeChordToken(token,steps){const [main,bass]=token.split('/');const tr=ch=>{const m=ch.match(/^([A-G])([#b])?(.*)$/);if(!m)return ch;let[,r,a,rest]=m;let full=r+(a||'');if(FLAT_EQ[full])full=FLAT_EQ[full];let i=NOTES.indexOf(full);if(i===-1)return ch;let ni=(i+steps)%12;if(ni<0)ni+=12;return NOTES[ni]+(rest||'');};return bass?tr(main)+'/'+tr(bass):tr(main);}
function applyTransposeToText(text,steps){return text.replace(/\[([^\]]+)\]/g,(_,ch)=>'['+ch.split(/\s+/).map(t=>transposeChordToken(t,steps)).join(' ')+']');}
function renderLineTwoRow(l){let lyric='',segs=[],acc='',inch=false,len=0;for(let i=0;i<l.length;i++){const ch=l[i];if(ch==='['){inch=true;acc='';}else if(ch===']'){inch=false;const pad=lyric.length-len;if(pad>0)segs.push({t:'s',l:pad});segs.push({t:'c',x:acc});len+=(pad>0?pad:0)+acc.length;}else if(inch){acc+=ch;}else{lyric+=ch;}}let out='';for(const s of segs){out+=s.t==='s'?' '.repeat(s.l):`<span class='chord-strong'>${esc(s.x)}</span>`;}return `<pre>${out}\n${esc(lyric)}</pre>`;}
function mapSectionToken(tok){const t=tok.trim().toUpperCase();if(t==='I')return{type:'intro',text:'I'};if(/^V\d+$/.test(t))return{type:'verse',text:t};if(t==='C')return{type:'chorus',text:'C'};if(t==='B')return{type:'bridge',text:'B'};if(t==='IT')return{type:'interlude',text:'It'};if(t==='O')return{type:'outro',text:'O'};return{type:'generic',text:t};}
function buildHeaderBadges(sectionListStr){if(!sectionListStr)return'';const toks=sectionListStr.split(',').map(s=>s.trim());return `<div class='header-badges'>${toks.map(tok=>{const {type,text}=mapSectionToken(tok);return`<span class='header-badge type-${type}'>${esc(text)}</span>`}).join('')}</div>`;}
function splitHeaderBlock(raw){const s=raw.indexOf('{start_header}'),e=raw.indexOf('{end_header}');if(s!=-1&&e!=-1){return{header:raw.slice(s+15,e),body:raw.slice(0,s)+raw.slice(e+13)};}return{header:null,body:raw};}
function parseMetaFields(text){const get=t=>{const m=text.match(new RegExp(`\\{${t}:\\s*(.*?)\\}`,'i'));return m?m[1].trim():null;};return{title:get('title'),artist:get('artist'),key:get('key'),time:get('time'),tempo:get('tempo'),capo:get('capo'),comment_box:get('comment_box'),section_list:get('section_list')};}
function renderHeader(headerText,meta){let h='<div class="header-box"><div class="header-content">';if(headerText){const f=parseMetaFields(headerText);if(f.title)h+=`<div class='title'>${esc(f.title)}</div>`;if(f.artist)h+=`<div class='subtitle'>${esc(f.artist)}</div>`;const metaItems=[f.key?`Key: ${f.key}`:'',f.tempo?`Tempo: ${f.tempo}`:'',f.time?`Time: ${f.time}`:'',f.capo?`Capo: ${f.capo}`:''].filter(Boolean);if(metaItems.length)h+=`<div class='meta-inline'>${metaItems.join(' | ')}</div>`;if(f.comment_box)h+=`<div style='margin-top:8px;border:1px solid #ccc;border-radius:8px;padding:4px 8px;display:inline-block;background:#fafafa;'>${esc(f.comment_box)}</div>`;if(f.section_list)h+=buildHeaderBadges(f.section_list);}
else if(meta){if(meta.title)h+=`<div class='title'>${esc(meta.title)}</div>`;if(meta.artist)h+=`<div class='subtitle'>${esc(meta.artist)}</div>`;const metaItems=[meta.key?`Key: ${meta.key}`:'',meta.tempo?`Tempo: ${meta.tempo}`:'',meta.time?`Time: ${meta.time}`:'',meta.capo?`Capo: ${meta.capo}`:''].filter(Boolean);if(metaItems.length)h+=`<div class='meta-inline'>${metaItems.join(' | ')}</div>`;if(meta.comment_box)h+=`<div style='margin-top:8px;border:1px solid #ccc;border-radius:8px;padding:4px 8px;display:inline-block;background:#fafafa;'>${esc(meta.comment_box)}</div>`;if(meta.section_list)h+=buildHeaderBadges(meta.section_list);}
return h+'</div></div>'; }
function renderBody(text){const lines=text.split('\n');const sections=[];let curr=[];let title=null,type='generic';function flush(){if(curr.length){sections.push({title,type,content:curr.join('\n')});curr=[];}}for(const l of lines){const m=l.match(/^\{comment:\s*(.*?)\}$/i);if(m){flush();title=m[1];if(/vers/i.test(title))type='verse';else if(/chorus/i.test(title))type='chorus';else if(/bridge/i.test(title))type='bridge';else if(/intro/i.test(title))type='intro';else if(/interlud/i.test(title))type='interlude';else type='generic';continue;}curr.push(l);}flush();
return sections.map(sec=>`<div class='section-box ${sec.type}'><div class='section-line'></div><div class='section-badge'>${sec.title.charAt(0).toUpperCase()}</div><div class='section-title'>${esc(sec.title)}</div>${sec.content.split('\n').map(renderLineTwoRow).join('')}</div>`).join('');}
function render(){const raw=document.getElementById('source').value;const {header,body}=splitHeaderBlock(raw);const meta=parseMetaFields(raw);const sel=document.getElementById('keySelect').value;const trText=applyTransposeToText(body,0);document.getElementById('outputArea').innerHTML=`
  <div class='column'>
    ${renderHeader(header,meta)}
    ${renderBody(trText)}
  </div>
  <div class='column'></div>`;}
document.getElementById('render').onclick=render;
document.getElementById('exportPdf').onclick=()=>{
  const styles=[...document.querySelectorAll('style')].map(s=>s.outerHTML).join('\n');
  const html=`<!doctype html><html><head><meta charset='utf-8'><title>Print Song</title>${styles}</head><body><div class='viewer'>${document.getElementById('outputArea').innerHTML}</div><footer>Printed for ministry use only — do not distribute.<br>For use of the Iglesia Bautista Nueva Esperanza Worship Team only.</footer></body></html>`;
  const w=window.open('','_blank');w.document.write(html);w.document.close();setTimeout(()=>{w.print();w.close();},300);
};
(function init(){const s=document.getElementById('keySelect');for(const k of MAJOR_KEYS){const o=document.createElement('option');o.value=k;o.textContent=k;s.appendChild(o);}})();
</script>
</body>
</html>
