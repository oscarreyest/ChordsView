<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChordPro Viewer</title>
<style>
body { font-family: Arial, sans-serif; margin: 2em; background:#fafafa; }
textarea { width:100%; height:200px; font-family:monospace; }
button { margin:5px; }
pre {
  font-family: monospace;
  white-space: pre;
  background:#fff;
  padding:0.6em;
  border:1px solid #ccc;
  border-radius:6px;
  line-height:1.4em;
  font-size:16px;
}
.song-meta { margin-bottom:1em; }
.song-title { font-size:1.6em; font-weight:bold; }
.song-artist { font-size:1.2em; color:#555; }
.song-key, .song-capo { font-size:1em; color:#777; }
</style>
</head>
<body>
<h2>ChordPro Viewer</h2>
<textarea id="input" placeholder="Paste your ChordPro text here..."></textarea><br>
<button onclick="loadExample()">Load Example</button>
<button onclick="render()">Render</button>
<button onclick="transpose(-1)">Transpose âˆ’</button>
<button onclick="transpose(1)">Transpose +</button>
<hr>
<div id="output"></div>

<script>
const NOTES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
let semitoneShift = 0;

function loadExample() {
  document.getElementById('input').value =
`{title: Amazing Grace}
{artist: Traditional}
{key: C}

[C]Amazing [G]grace, how [C]sweet the [F]sound
That [C]saved a [G]wretch like [C]me
I [C]once was [F]lost, but [C]now am [G]found
Was [C]blind but [G]now I [C]see`;
}

function transposeChord(chord) {
  const regex = /^([A-G])(#|b)?(.*)$/;
  const match = chord.match(regex);
  if (!match) return chord;
  let [, root, accidental, rest] = match;
  let fullNote = root + (accidental || '');
  const flatToSharp = { Db:'C#', Eb:'D#', Gb:'F#', Ab:'G#', Bb:'A#' };
  if (flatToSharp[fullNote]) fullNote = flatToSharp[fullNote];
  let idx = NOTES.indexOf(fullNote);
  if (idx < 0) return chord;
  let newIndex = (idx + semitoneShift + 12) % 12;
  return NOTES[newIndex] + rest;
}

function transpose(delta) {
  semitoneShift += delta;
  render();
}

function processChordPro(text) {
  const lines = text.split('\n');
  let html = '';
  let title='', artist='', key='', capo='';

  for (const line of lines) {
    if (line.startsWith('{')) {
      const m = line.match(/^\{(\w+):\s*(.*?)\}$/);
      if (m) {
        const tag = m[1].toLowerCase();
        const val = m[2];
        if (tag === 'title') title = val;
        else if (tag === 'artist') artist = val;
        else if (tag === 'key') key = val;
        else if (tag === 'capo') capo = val;
      }
      continue;
    }

    if (line.trim() === '') { html += '<br>'; continue; }

    let chordLine = '';
    let lyricLine = '';
    let chordBuffer = '';
    let inChord = false;

    for (const char of line) {
      if (char === '[') {
        inChord = true; chordBuffer = '';
      } else if (char === ']') {
        inChord = false;
        const spaces = lyricLine.length - chordLine.length;
        if (spaces > 0) chordLine += ' '.repeat(spaces);
        chordLine += chordBuffer;
      } else if (inChord) {
        chordBuffer += char;
      } else {
        lyricLine += char;
      }
    }

    if (chordLine.trim()) html += `<pre>${chordLine}\n${lyricLine}</pre>`;
    else if (lyricLine.trim()) html += `<pre>${lyricLine}</pre>`;
  }

  let metaHTML = '<div class="song-meta">';
  if (title) metaHTML += `<div class="song-title">${title}</div>`;
  if (artist) metaHTML += `<div class="song-artist">${artist}</div>`;
  if (key || capo) {
    metaHTML += `<div class="song-key">`;
    if (key) metaHTML += `Key: ${key} `;
    if (capo) metaHTML += ` Capo: ${capo}`;
    metaHTML += `</div>`;
  }
  metaHTML += '</div>';

  return metaHTML + html;
}

function render() {
  let txt = document.getElementById('input').value;
  txt = txt.replace(/\[([A-G][#b]?[^\]]*)\]/g, (_, chord) => `[${transposeChord(chord)}]`);
  document.getElementById('output').innerHTML = processChordPro(txt);
}
</script>
</body>
</html>
