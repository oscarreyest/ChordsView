<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ChordPro Viewer — Final Build</title>

<style>
/* ---------------------------------------------------------
   Root color variables (screen)
--------------------------------------------------------- */
:root{
  --page-bg:#f7f8fa;
  --card-bg:#ffffff;
  --muted:#6b7280;
  --accent:#1f6feb;

  /* Section backgrounds */
  --generic-bg:#f8f9fa;
  --verse-bg:#f3fdf3;
  --chorus-bg:#eef6ff;
  --bridge-bg:#fffbea;
  --intro-bg:#f9f5ff;
  --interlude-bg:#faf5ff;
  --outro-bg:#f8f5f9;

  /* Section accent colors */
  --verse-ac:#81c784;
  --chorus-ac:#64b5f6;
  --bridge-ac:#f6d860;
  --intro-ac:#b39ddb;
  --interlude-ac:#ce93d8;
  --outro-ac:#b39ddb;
  --generic-ac:#cfd8dc;
}

/* ---------------------------------------------------------
   Base layout
--------------------------------------------------------- */
body{
  background:var(--page-bg);
  font-family:Georgia, "Times New Roman", serif;
  color:#111;
  margin:0;
}

.wrap{
  max-width:900px;
  margin:28px auto;
  padding:18px;
}

header h1{
  margin:0;
  font-size:28px;
  font-weight:800;
}

header p{
  margin:6px 0 18px;
  color:var(--muted);
  font-family:system-ui, sans-serif;
}

/* ---------------------------------------------------------
   Card / editor area
--------------------------------------------------------- */
.card{
  background:var(--card-bg);
  border-radius:12px;
  padding:16px;
  box-shadow:0 2px 6px rgba(0,0,0,0.08);
  margin-bottom:14px;
}

textarea#source{
  width:100%;
  min-height:200px;
  border-radius:8px;
  padding:14px;
  border:1px solid #e1e4ea;
  font-family:monospace;
  font-size:14px;
  line-height:1.4;
}

/* ---------------------------------------------------------
   Controls
--------------------------------------------------------- */
.controls{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
  margin-top:10px;
}

.btn{
  padding:8px 14px;
  border-radius:8px;
  cursor:pointer;
  font-family:system-ui;
  border:1px solid var(--accent);
  background:white;
  color:var(--accent);
}

.btn.primary{
  background:var(--accent);
  color:white;
}

.controls .right{
  margin-left:auto;
  display:flex;
  align-items:center;
  gap:8px;
}

select#keySelect{
  padding:8px;
  border-radius:8px;
  border:1px solid #bfc6d9;
  font-weight:600;
}

/* ---------------------------------------------------------
   Viewer layout
--------------------------------------------------------- */
.viewer{
  background:white;
  border-radius:12px;
  padding:24px;
  box-shadow:0 2px 6px rgba(0,0,0,0.06);
}

.title{
  font-size:32px;
  font-weight:800;
  margin-bottom:4px;
}

.subtitle{
  font-size:18px;
  font-style:italic;
  color:var(--muted);
  margin-bottom:6px;
}

.meta-row{
  font-size:14px;
  color:var(--muted);
  font-family:system-ui;
}

/* ---------------------------------------------------------
   Section Boxes
--------------------------------------------------------- */
.section-box{
  margin:22px 0;
  padding:18px 16px 16px;
  border-radius:12px;
  border:1px solid #dce2ea;
  position:relative;
  page-break-inside:avoid;
}

/* Section background colors */
.section-box.verse      { background:var(--verse-bg); }
.section-box.chorus     { background:var(--chorus-bg); }
.section-box.bridge     { background:var(--bridge-bg); }
.section-box.intro      { background:var(--intro-bg); }
.section-box.interlude  { background:var(--interlude-bg); }
.section-box.outro      { background:var(--outro-bg); }
.section-box.generic    { background:var(--generic-bg); }

/* Title */
.section-title{
  margin-top:6px;
  font-family:system-ui;
  font-weight:700;
  color:#1f6feb;
}

/* Badge circle */
.section-badge{
  position:absolute;
  top:-14px;
  left:16px;
  min-width:26px;
  height:26px;
  border-radius:50%;
  background:white;
  border:2px solid var(--generic-ac);
  font-size:12px;
  font-weight:800;
  display:flex;
  align-items:center;
  justify-content:center;
}

/* Colored top line */
.section-line{
  position:absolute;
  top:0;
  left:52px;
  right:16px;
  height:2px;
  background:var(--generic-ac);
  border-radius:3px;
}

/* ---------------------------------------------------------
   Section-specific accent coloring
--------------------------------------------------------- */
.section-box.verse      .section-line,
.section-box.verse      .section-badge{ border-color:var(--verse-ac); background:none; }

.section-box.chorus     .section-line,
.section-box.chorus     .section-badge{ border-color:var(--chorus-ac); background:none; }

.section-box.bridge     .section-line,
.section-box.bridge     .section-badge{ border-color:var(--bridge-ac); background:none; }

.section-box.intro      .section-line,
.section-box.intro      .section-badge{ border-color:var(--intro-ac); background:none; }

.section-box.interlude  .section-line,
.section-box.interlude  .section-badge{ border-color:var(--interlude-ac); background:none; }

.section-box.outro      .section-line,
.section-box.outro      .section-badge{ border-color:var(--outro-ac); background:none; }

/* ---------------------------------------------------------
   Lyrics + Chords
--------------------------------------------------------- */
pre{
  font-family:"Courier New", monospace;
  white-space:pre;
  font-size:16px;
  line-height:1.6;
  margin:8px 0;
  padding:6px;
  background:white;
  border:1px solid #eee;
  border-radius:4px;
}

.chord-strong{
  font-size:17px;
  font-weight:700;
}

/* ---------------------------------------------------------
   Large Text Toggle
--------------------------------------------------------- */
.viewer.large-text pre{
  font-size:20px !important;
  line-height:1.75 !important;
}

.viewer.large-text .chord-strong{
  font-size:21px !important;
}

/* ---------------------------------------------------------
   Print mode (B&W)
--------------------------------------------------------- */
@media print {

  body{ margin:12mm; background:white; }

  .controls,
  .no-print{
    display:none !important;
  }

  .viewer{
    box-shadow:none;
    padding:0;
    column-count:2;
    column-gap:20mm;
  }

  .section-box{
    background:white !important;
    border:1px solid #555 !important;
    break-inside:avoid;
  }

  .section-line{
    background:#555 !important;
  }

  .section-badge{
    background:white !important;
    border-color:#222 !important;
    color:black !important;
  }

  pre{
    white-space:pre-wrap;
    word-break:break-word;
    background:none;
    border:none;
    font-size:16px;
  }

  .title{
    font-size:26px;
  }

  @page{ margin:12mm; }
}

</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ChordPro Viewer</h1>
      <p>Final build: header block, section boxes, badges, transpose, large text, PDF export.</p>
    </header>

    <div class="card">
      <label for="source" style="display:block;font-weight:600;margin-bottom:8px">ChordPro source</label>
      <textarea id="source" placeholder="{title: Song}
{artist: Someone}
{key: C}
{time: 4/4}
{tempo: 120}

{start_header}
{title: My Song}
{artist: The Band}
{comment: Special arrangement}
{comment_box: For ministry use only}
{end_header}

{comment: Intro}
[C]Hello [G]world"></textarea>

      <div class="controls no-print">
        <button id="render" class="btn primary">Render</button>
        <button id="downloadCho" class="btn">Download .cho</button>
        <button id="shareLink" class="btn">Share Link</button>
        <button id="toggleLargeText" class="btn">Large Text</button>
        <button id="exportPdf" class="btn">Export PDF / Print</button>

        <div class="right">
          <label for="keySelect" style="font-weight:600;margin-right:6px;color:#333">Select Key:</label>
          <select id="keySelect" aria-label="Transpose to key" title="Transpose to key">
            <option value="">(original)</option>
          </select>
        </div>
      </div>

      <div class="hint" style="font-size:13px;color:var(--muted);margin-top:6px;font-family:system-ui,sans-serif">
        Header block: <code>{start_header} ... {end_header}</code> (raw text, no chord parsing).<br/>
        Section helpers: <code>{comment: Verse 1}</code>, <code>{start_of_chorus}</code>/<code>{end_of_chorus}</code>, <code>{prechorus}</code>, <code>{bridge}</code>, <code>{interlude}</code>, etc.
      </div>
    </div>

    <div id="outputArea" class="viewer card" aria-live="polite"></div>

    <footer>ChordPro Viewer — Final build · GitHub Pages friendly</footer>
  </div>

<script>
/* ============================================================
   Utilities
============================================================ */
const MAJOR_KEYS=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const NOTES=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const FLAT_EQ={Db:'C#',Eb:'D#',Gb:'F#',Ab:'G#',Bb:'A#'};
let transposeSteps=0,songOriginalKey=null;

const esc = s => (s??'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

/* Transpose */
function transposeChordToken(token, steps){
  const [main,bass]=token.split('/');
  const tr = (ch)=>{
    const m=ch.match(/^([A-G])([#b])?(.*)$/); if(!m) return ch;
    let[,root,acc,rest]=m; let full=root+(acc||'');
    if(FLAT_EQ[full]) full=FLAT_EQ[full];
    let i=NOTES.indexOf(full); if(i===-1) return ch;
    let ni=(i+steps)%12; if(ni<0) ni+=12;
    return NOTES[ni]+(rest||'');
  };
  return bass? tr(main)+'/'+tr(bass) : tr(main);
}
function applyTransposeToText(text, steps){
  return text.replace(/\[([^\]]+)\]/g,(_,ch)=>'['+ch.split(/\s+/).filter(Boolean).map(t=>transposeChordToken(t,steps)).join(' ')+']');
}

/* Two-row chord/lyric renderer */
function renderLineTwoRow(line){
  let lyric='',segs=[],acc='',inch=false,len=0;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='['){inch=true;acc='';}
    else if(ch===']'){
      inch=false;
      const pad=lyric.length-len; if(pad>0) segs.push({t:'s',l:pad});
      segs.push({t:'c',x:acc}); len+=(pad>0?pad:0)+acc.length;
    }else if(inch){acc+=ch;}
    else{lyric+=ch;}
  }
  let out=''; for(const s of segs){out+= s.t==='s' ? ' '.repeat(s.l) : `<span class="chord-strong">${esc(s.x)}</span>`;}
  if(out.trim()) return `<pre>${out}\n${esc(lyric)}</pre>`;
  if(lyric.trim()) return `<pre>${esc(lyric)}</pre>`;
  return '<div style="height:8px"></div>';
}

/* Section classification */
function classifySection(labelGuess, tokenType=null){
  const t=(labelGuess||'').toLowerCase();
  if(tokenType==='chorus')    return {type:'chorus',    title:labelGuess||'Chorus'};
  if(tokenType==='bridge')    return {type:'bridge',    title:labelGuess||'Bridge'};
  if(tokenType==='verse')     return {type:'verse',     title:labelGuess||'Verse'};
  if(tokenType==='intro')     return {type:'intro',     title:labelGuess||'Intro'};
  if(tokenType==='prechorus') return {type:'prechorus', title:labelGuess||'Pre-Chorus'};
  if(tokenType==='interlude') return {type:'interlude', title:labelGuess||'Interlude'};
  if(tokenType==='outro')     return {type:'outro',     title:labelGuess||'Outro'};

  if(/(pre[\s-]?chor(us|o)|pre\s*coro)/i.test(t))  return {type:'prechorus', title:labelGuess||'Pre-Chorus'};
  if(/(chorus|coro|estribillo)/i.test(t))          return {type:'chorus',    title:labelGuess||'Chorus'};
  if(/(bridge|puente)/i.test(t))                   return {type:'bridge',    title:labelGuess||'Bridge'};
  if(/(verse|verso|estrofa)/i.test(t))             return {type:'verse',     title:labelGuess||'Verse'};
  if(/(intro)/i.test(t))                           return {type:'intro',     title:labelGuess||'Intro'};
  if(/(interlude|interludio)/i.test(t))            return {type:'interlude', title:labelGuess||'Interlude'};
  if(/(outro|final)/i.test(t))                     return {type:'outro',     title:labelGuess||'Outro'};
  if(/(refrain|refr[aá]n)/i.test(t))               return {type:'generic',   title:labelGuess||'Refrain'};
  if(/(solo)/i.test(t))                            return {type:'generic',   title:labelGuess||'Solo'};

  return {type:'generic', title:labelGuess||'Section'};
}
function autoBadgeFrom(type, title){
  const n=(title||'').match(/(\d+)/); const num = n? n[1] : '';
  switch(type){
    case 'verse': return 'V'+num;
    case 'prechorus': return 'Pc';
    case 'chorus': return 'C';
    case 'bridge': return 'B';
    case 'intro': return 'I';
    case 'interlude': return 'It';
    case 'outro': return 'O';
    default: return '';
  }
}

/* ------------------------------------------------------------
   HEADER SUPPORT
   - {start_header} ... {end_header} block is raw & centered
   - No chord parsing in header
   - {comment} shown as plain text
   - {comment_box} shown in a simple gray box
   - Blank lines are IGNORED inside header (per your choice)
   - Auto-header fallback if no header block present
------------------------------------------------------------ */
function splitHeaderBlock(raw){
  const start = raw.indexOf('{start_header}');
  const end   = raw.indexOf('{end_header}');
  if(start !== -1 && end !== -1 && end > start){
    const before = raw.slice(0, start);
    const header = raw.slice(start + '{start_header}'.length, end);
    const after  = raw.slice(end + '{end_header}'.length);
    return { header, body: before + after, hasExplicit:true };
  }
  return { header:null, body:raw, hasExplicit:false };
}
function parseMetaFields(text){
  // return first occurrences for auto-header
  const get = (tag)=>{
    const m = text.match(new RegExp(`\\{${tag}:\\s*(.*?)\\}`, 'i'));
    return m ? m[1].trim() : null;
  };
  return {
    title: get('title'),
    subtitle: get('subtitle'),
    artist: get('artist'),
    album: get('album'),
    key: get('key'),
    time: get('time'),
    tempo: get('tempo'),
    capo: get('capo'),
    comment: get('comment'),
    comment_box: get('comment_box')
  };
}
function renderHeaderRaw(headerText, metaFallback=null){
  let out = '<div style="text-align:center;margin-bottom:10px">';
  const pushLine = (html)=>{ out += `<div>${html}</div>`; };

  if(headerText){ // explicit header: treat each non-empty line
    const lines = headerText.replace(/\r/g,'').split('\n');
    for(const raw of lines){
      const line = raw.trim(); if(!line) continue; // ignore blanks
      const kv = line.match(/^\{([^:}]+):\s*(.*?)\}$/);
      if(kv){
        const tag = kv[1].toLowerCase(), val = esc(kv[2]);
        if(tag==='title') pushLine(`<div class="title" style="margin:0 auto">${val}</div>`);
        else if(tag==='subtitle') pushLine(`<div class="subtitle" style="margin:4px 0">${val}</div>`);
        else if(tag==='artist') pushLine(`<div class="meta-row">Artist: ${val}</div>`);
        else if(tag==='album') pushLine(`<div class="meta-row">Album: ${val}</div>`);
        else if(tag==='key' || tag==='time' || tag==='tempo' || tag==='capo') pushLine(`<div class="meta-row">${esc(tag[0].toUpperCase()+tag.slice(1))}: ${val}</div>`);
        else if(tag==='comment') pushLine(`<div class="meta-row">${val}</div>`);
        else if(tag==='comment_box') pushLine(`<div style="display:inline-block;border:1px solid #d4d8e0;border-radius:8px;padding:6px 10px;margin:6px 0;background:#fafafa">${val}</div>`);
        else pushLine(esc(line));
      }else{
        pushLine(esc(line));
      }
    }
    out += '</div>';
    return out;
  }

  // Auto-header fallback
  if(metaFallback && (metaFallback.title || metaFallback.artist || metaFallback.key || metaFallback.time || metaFallback.tempo || metaFallback.capo || metaFallback.comment || metaFallback.comment_box)){
    if(metaFallback.title)      pushLine(`<div class="title" style="margin:0 auto">${esc(metaFallback.title)}</div>`);
    if(metaFallback.subtitle)   pushLine(`<div class="subtitle" style="margin:4px 0">${esc(metaFallback.subtitle)}</div>`);
    if(metaFallback.artist || metaFallback.album){
      let line='';
      if(metaFallback.artist) line += `Artist: ${esc(metaFallback.artist)}`;
      if(metaFallback.artist && metaFallback.album) line += ' • ';
      if(metaFallback.album)  line += `Album: ${esc(metaFallback.album)}`;
      pushLine(`<div class="meta-row">${line}</div>`);
    }
    const extras=[];
    if(metaFallback.key)   extras.push('Key: '+esc(metaFallback.key));
    if(metaFallback.time)  extras.push('Time: '+esc(metaFallback.time));
    if(metaFallback.tempo) extras.push('Tempo: '+esc(metaFallback.tempo));
    if(metaFallback.capo)  extras.push('Capo: '+esc(metaFallback.capo));
    if(extras.length) pushLine(`<div class="meta-row">${extras.join(' • ')}</div>`);
    if(metaFallback.comment)     pushLine(`<div class="meta-row">${esc(metaFallback.comment)}</div>`);
    if(metaFallback.comment_box) pushLine(`<div style="display:inline-block;border:1px solid #d4d8e0;border-radius:8px;padding:6px 10px;margin:6px 0;background:#fafafa">${esc(metaFallback.comment_box)}</div>`);
    out += '</div>';
    return out;
  }

  // No header
  return '';
}

/* ------------------------------------------------------------
   BODY PARSER (sections, badges, etc.)
------------------------------------------------------------ */
function parseChordProBody(text){
  const lines=text.replace(/\r/g,'').split('\n');
  const parts=[];
  let sectionOpen=false, blockType=null;

  let nextNoBadge=false, nextNoLine=false, nextBadge=null, nextPlain=false;

  const openSection=(labelGuess, tokenType=null)=>{
    const cls = classifySection(labelGuess, tokenType);
    const type = cls.type, title = cls.title;

    const hideBadge = nextPlain || nextNoBadge;
    const hideLine  = nextPlain || nextNoLine;
    const badgeText = nextPlain ? '' : (nextBadge!=null ? nextBadge : autoBadgeFrom(type, title));

    parts.push(`<div class="section-box ${type}">`);
    if(!hideLine) parts.push(`<div class="section-line"></div>`);
    if(badgeText) parts.push(`<div class="section-badge">${esc(badgeText)}</div>`);
    parts.push(`<div class="section-title">${esc(title)}</div>`);

    nextNoBadge=false; nextNoLine=false; nextBadge=null; nextPlain=false;
    sectionOpen=true;
  };
  const closeSection=()=>{ if(sectionOpen){ parts.push('</div>'); sectionOpen=false; } };

  for(const raw of lines){
    const line=raw.trimEnd();

    // overrides for next section
    const ovBadge=line.match(/^\{badge:\s*(.*?)\}$/i);
    if(ovBadge){ nextBadge = ovBadge[1]; continue; }
    if(/^\{no_badge\}$/i.test(line)){ nextNoBadge=true; continue; }
    if(/^\{no_line\}$/i.test(line)){ nextNoLine=true; continue; }
    if(/^\{plain_section\}$/i.test(line)){ nextPlain=true; continue; }

    // key/value tags (body-level)
    const kv=line.match(/^\{([^:}]+):\s*(.*?)\}$/);
    if(kv){
      const tag=kv[1].toLowerCase(), val=kv[2];

      if(tag==='comment'){
        closeSection(); openSection(val,null);
      }else if(tag==='comment_italic'){
        if(!sectionOpen) openSection('Section',null);
        parts.push(`<div class="comment" style="font-style:italic">${esc(val)}</div>`);
      }else if(tag==='comment_box'){
        if(!sectionOpen) openSection('Section',null);
        parts.push(`<div class="comment box">${esc(val)}</div>`);
      }
      // ignore meta tags here; header already handled
      continue;
    }

    // single tokens
    const token=line.match(/^\{([a-zA-Z0-9_\-]+)\}$/);
    if(token){
      const tkn=token[1].toLowerCase();
      if(['start_of_chorus','soc','start_chorus'].includes(tkn)){ closeSection(); blockType='chorus'; openSection('Chorus','chorus'); continue; }
      if(['start_of_bridge','start_bridge'].includes(tkn)){       closeSection(); blockType='bridge'; openSection('Bridge','bridge'); continue; }
      if(['verse','verso','estrofa'].includes(tkn)){              closeSection(); blockType=null;     openSection('Verse','verse');   continue; }
      if(['intro'].includes(tkn)){                                closeSection(); blockType=null;     openSection('Intro','intro');   continue; }
      if(['interlude'].includes(tkn)){                            closeSection(); blockType=null;     openSection('Interlude','interlude'); continue; }
      if(['outro'].includes(tkn)){                                closeSection(); blockType=null;     openSection('Outro','outro');   continue; }
      if(['prechorus','pre_chorus'].includes(tkn)){               closeSection(); blockType=null;     openSection('Pre-Chorus','prechorus'); continue; }
      if(['start_of_tab','start_tab'].includes(tkn)){             if(!sectionOpen) openSection('Tab','generic'); blockType='tab'; continue; }
      if(['end_of_chorus','eoc','end_chorus','end_of_bridge','end_bridge','end_of_tab','end_tab','end_of_comment','end_comment'].includes(tkn)){
        blockType=null; closeSection(); continue;
      }
      continue;
    }

    // blank line spacing
    if(line.trim()===''){ parts.push('<div style="height:10px"></div>'); continue; }

    // content line
    if(!sectionOpen) openSection('Section',null);
    if(blockType==='tab') parts.push(`<pre>${esc(line)}</pre>`);
    else                 parts.push(renderLineTwoRow(line));
  }

  closeSection();
  return parts.join('');
}

/* ------------------------------------------------------------
   Top-level renderer
------------------------------------------------------------ */
function renderAll(rawInput){
  // Find header block (or build auto-header)
  const {header, body, hasExplicit} = splitHeaderBlock(rawInput);
  const meta = parseMetaFields(rawInput);
  const headerHtml = renderHeaderRaw(header, hasExplicit? null : meta);

  // Body with musical parsing
  const bodyHtml = parseChordProBody(body);

  // Assemble
  return headerHtml + bodyHtml;
}
/* ============================================================
   Transpose helpers + UI wiring
============================================================ */
function normalizeKey(k){
  if(!k) return null;
  const m = k.trim().match(/^([A-G])([#b]?)(m?)$/i);
  if(!m) return null;
  let root=m[1].toUpperCase(), acc=m[2]||'', min=m[3]?'m':'';
  let full=root+acc;
  if(FLAT_EQ[full]) full=FLAT_EQ[full];
  return full+min;
}
function computeSemitoneDiff(a,b){
  const nf=normalizeKey(a), nt=normalizeKey(b);
  if(!nf||!nt) return 0;
  const i1=NOTES.indexOf(nf.replace(/m$/,'')), i2=NOTES.indexOf(nt.replace(/m$/,''));
  let d=i2-i1; if(d>6)d-=12; if(d<-6)d+=12; return d;
}
function fillKeySelect(){
  const s=document.getElementById('keySelect');
  s.innerHTML='<option value="">(original)</option>';
  for(const k of MAJOR_KEYS){ const o=document.createElement('option'); o.value=k;   o.textContent=k;   s.appendChild(o); }
  const sep=document.createElement('option'); sep.disabled=true; sep.textContent='── minor keys ──'; s.appendChild(sep);
  for(const k of MAJOR_KEYS){ const o=document.createElement('option'); o.value=k+'m'; o.textContent=k+'m'; s.appendChild(o); }
}

/* ============================================================
   Render pipeline
   - transpose applies ONLY to body (not the header block)
============================================================ */
function render(){
  const raw = document.getElementById('source').value || '';

  // Determine original key from meta for transpose math
  const meta = parseMetaFields(raw);
  songOriginalKey = meta.key ? meta.key.replace(/\s+/g,'') : null;

  // Split header/body once
  const {header, body, hasExplicit} = splitHeaderBlock(raw);

  // Compute transpose steps from current select
  const sel = document.getElementById('keySelect').value;
  transposeSteps = (sel && songOriginalKey) ? computeSemitoneDiff(songOriginalKey, sel) : 0;

  // Transpose only the body (chord brackets)
  const bodyT = applyTransposeToText(body, transposeSteps);

  // Build header (explicit or auto)
  const headerHtml = renderHeaderRaw(header, hasExplicit ? null : meta);

  // Build body sections
  const bodyHtml = parseChordProBody(bodyT);

  // Output
  document.getElementById('outputArea').innerHTML = headerHtml + bodyHtml;
}

/* ============================================================
   Buttons & Events
============================================================ */
document.getElementById('render').addEventListener('click', render);

document.getElementById('keySelect').addEventListener('change', render);

document.getElementById('downloadCho').addEventListener('click', ()=>{
  const text=document.getElementById('source').value||'';
  const blob=new Blob([text],{type:'text/plain;charset=utf-8'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  // try to use title for filename
  let name='song';
  const m=text.match(/\{title:\s*(.+?)\}/i); if(m) name=m[1].trim().replace(/[^\w\- ]+/g,'').replace(/\s+/g,'_');
  a.download=name+'.cho';
  a.click();
  URL.revokeObjectURL(a.href);
});

document.getElementById('shareLink').addEventListener('click', async ()=>{
  const text=document.getElementById('source').value||'';
  const enc=btoa(unescape(encodeURIComponent(text)));
  const url=location.origin+location.pathname+'?song='+enc;
  try{
    await navigator.clipboard.writeText(url);
    alert('Link copied to clipboard');
  }catch(e){
    prompt('Copy this link:', url);
  }
});

document.getElementById('exportPdf').addEventListener('click', ()=>{
  // Re-render current HTML (already transposed) and print in B&W columns
  const html = document.getElementById('outputArea').innerHTML;
  const title=(document.querySelector('.title')?.textContent)||'ChordPro Song';
  const w=window.open('','_blank');
  const css=`
    body{font-family:Georgia,"Times New Roman",serif;margin:15mm;color:#111;background:#fff;}
    .title{font-size:26px;font-weight:700;margin-bottom:6px}
    .meta-row{font-size:11px;color:#666;margin-bottom:6px}
    pre{font-family:"Courier New",Courier,monospace;font-size:16px;line-height:1.45;white-space:pre-wrap;word-break:break-word;margin:4px 0;border:none;background:none}
    .chord-strong{font-size:17px;font-weight:700}
    .section-box{background:#fff !important;border:1px solid #666 !important;border-radius:12px;padding:18px 14px 14px 14px;margin:18px 0;position:relative;break-inside:avoid}
    .section-badge{position:absolute;top:-14px;left:14px;min-width:26px;height:26px;display:flex;align-items:center;justify-content:center;background:#fff;border-radius:50%;padding:0 6px;font-size:12px;font-weight:800;border:2px solid #222 !important;color:#000 !important}
    .section-line{position:absolute;top:0;left:52px;right:12px;height:2px;background:#444 !important;border-radius:2px}
    .section-title{font-weight:700;color:#000 !important;margin:8px 0 6px 0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}
    .viewer{column-count:2;column-gap:22mm;column-fill:auto;background:#fff !important}
    .song-meta,.section-title,pre,.comment{break-inside:avoid;page-break-inside:avoid}
    @page{margin:15mm}
  `;
  w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>${esc(title)}</title><style>${css}</style></head><body><div class="viewer">${html}</div></body></html>`);
  w.document.close(); w.focus(); setTimeout(()=>{ w.print(); }, 250);
});

document.getElementById('toggleLargeText').addEventListener('click', ()=>{
  const viewer=document.getElementById('outputArea');
  const btn=document.getElementById('toggleLargeText');
  viewer.classList.toggle('large-text');
  btn.textContent = viewer.classList.contains('large-text') ? 'Normal Text' : 'Large Text';
});

/* ============================================================
   Init
============================================================ */
fillKeySelect();
// Load from ?song=... if present
(function(){
  const params=new URLSearchParams(location.search);
  if(params.has('song')){
    try{
      document.getElementById('source').value = decodeURIComponent(escape(atob(params.get('song'))));
    }catch(e){
      document.getElementById('source').value = params.get('song');
    }
  }
})();
render();
</script>
</body>
</html>
