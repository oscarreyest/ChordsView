<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Song Chart Editor</title>
<style>
  :root {
    --page-bg:#f7f8fa; --card-bg:#ffffff; --muted:#6b7280; --accent:#1f6feb;
    --verse-ac:#81c784; --chorus-ac:#64b5f6; --bridge-ac:#f6d860;
    --intro-ac:#b39ddb; --interlude-ac:#ce93d8; --outro-ac:#b39ddb;
    --verse-bg:#f3fdf3; --chorus-bg:#eef6ff; --bridge-bg:#fffbea;
    --intro-bg:#f9f5ff; --interlude-bg:#faf5ff; --outro-bg:#f8f5f9;
    --generic-bg:#f8f9fa; --generic-ac:#cfd8dc;
    --lyric-size:16px; --chord-size:17px; --section-title:16px;
    --meta-size:14px; --badge-font:12px; --title-size:32px;
    --subtitle-size:18px; --viewer-pad:24px; --column-gap:22mm;
  }
  html,body{margin:0;height:100%;background:var(--page-bg);
    font-family:Georgia,"Times New Roman",serif;color:#111;}
  .wrap{max-width:900px;margin:28px auto;padding:18px;}
  header h1{margin:0;font-size:28px;font-weight:800;text-align:center}
  header p{text-align:center;margin:6px 0 18px;color:var(--muted);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;}

  .card{background:var(--card-bg);border-radius:12px;padding:16px;
    box-shadow:0 2px 6px rgba(0,0,0,.08);margin-bottom:14px;}
  textarea#source{width:100%;min-height:200px;border-radius:8px;
    padding:14px;border:1px solid #e1e4ea;font-family:monospace;font-size:14px;}

  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px;}
  .btn{padding:8px 14px;border-radius:8px;cursor:pointer;font-family:system-ui;
    border:1px solid var(--accent);background:#fff;color:var(--accent);}
  .btn.primary{background:var(--accent);color:#fff;}
  .controls .right{margin-left:auto;display:flex;align-items:center;gap:8px;}
  select#keySelect{padding:8px;border-radius:8px;border:1px solid #bfc6d9;font-weight:600;}

  .viewer{background:#fff;border-radius:12px;padding:var(--viewer-pad);
    box-shadow:0 2px 6px rgba(0,0,0,.06);}
  .title{text-align:center;font-size:var(--title-size);font-weight:800;margin:0 0 4px;}
  .meta-row{text-align:center;font-size:var(--meta-size);color:var(--muted);}
  .meta-inline span{margin:0 6px;}
  .key-label{text-align:center;margin:8px 0;font-size:14px;color:#333;
    display:inline-block;padding:4px 10px;border:1px solid #d4d8e0;border-radius:8px;
    background:#fafafa;}

  .header-box{border:1px solid #dce2ea;border-radius:12px;padding:14px 16px;
    margin-bottom:12px;text-align:center;}
  .header-badges{display:flex;justify-content:center;flex-wrap:wrap;gap:10px;margin-top:10px;}
  .header-badge{min-width:26px;height:26px;display:flex;align-items:center;justify-content:center;
    font-size:var(--badge-font);font-weight:800;border-radius:50%;border:2px solid var(--generic-ac);
    background:#fff;color:#111;}
  .header-badge.type-verse{border-color:var(--verse-ac)}
  .header-badge.type-chorus{border-color:var(--chorus-ac)}
  .header-badge.type-bridge{border-color:var(--bridge-ac)}
  .header-badge.type-intro{border-color:var(--intro-ac)}
  .header-badge.type-interlude{border-color:var(--interlude-ac)}
  .header-badge.type-outro{border-color:var(--outro-ac)}

  .section-box{margin:22px 0;padding:18px;border-radius:12px;border:1px solid #dce2ea;
    page-break-inside:avoid;break-inside:avoid;}
  .section-title{margin:8px 0 6px;font-weight:700;color:#1f6feb;font-size:var(--section-title);}
  .section-box.verse{background:var(--verse-bg)}
  .section-box.chorus{background:var(--chorus-bg)}
  .section-box.bridge{background:var(--bridge-bg)}
  .section-box.intro{background:var(--intro-bg)}
  .section-box.interlude{background:var(--interlude-bg)}
  .section-box.outro{background:var(--outro-bg)}

  pre{font-family:"Courier New",monospace;white-space:pre;
    font-size:var(--lyric-size);line-height:1.6;margin:8px 0;
    background:#fff;border:1px solid #eee;border-radius:4px;padding:6px;}
  .chord-strong{font-weight:700;font-size:var(--chord-size);}
  .viewer.two-col{column-count:2;column-gap:var(--column-gap);}
  .viewer.two-col .section-box{break-inside:avoid;page-break-inside:avoid;}
  footer{margin-top:12px;color:var(--muted);font-size:13px;text-align:center;}
  @media print{body{margin:12mm;background:#fff}
    .controls,.no-print{display:none!important}
    .viewer{box-shadow:none;padding:0}@page{size:Letter;margin:12mm}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Song Chart Editor</h1>
    <p>Unified layout for screen & print, fits Letter page, preserves chord alignment.</p>
  </header>

  <div class="card">
    <label for="source" style="display:block;font-weight:600;margin-bottom:8px">ChordPro source</label>
    <textarea id="source" placeholder="{start_header}
{title: Tú Eres Digno de Gloria}
{artist: ICZ Worship}
{key: Am}
{time: 4/4}
{tempo: 126}
{comment_box: Key changed to: [Am]}
{section_list: I, V1, C, B }
{end_header}

{comment: Intro} 		
[F]   [G]   [F]   [G]
{comment: Verso}		                 
Hoy te alabamos Señ[F]or  [G]
Y declaramos que [F]Tú eres nuestro Di[G]os
..."></textarea>

    <div class="controls no-print">
      <button id="render" class="btn primary">Render</button>
      <button id="downloadCho" class="btn">Download .cho</button>
      <button id="shareLink" class="btn">Share Link</button>
      <button id="exportPdf" class="btn">Export PDF / Print</button>
      <div class="right">
        <label for="keySelect" style="font-weight:600;margin-right:6px;">Select Key:</label>
        <select id="keySelect">
          <option value="">(original)</option>
        </select>
      </div>
    </div>
  </div>

  <div id="outputArea" class="viewer card" aria-live="polite"></div>

  <footer>Printed for ministry use only — do not distribute. For use of the Iglesia Bautista Nueva Esperanza Worship Team only.</footer>
</div>

<script>
const MAJOR_KEYS=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const NOTES=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const FLAT_EQ={Db:'C#',Eb:'D#',Gb:'F#',Ab:'G#',Bb:'A#'};
let transposeSteps=0,songOriginalKey=null;
const esc=s=>(s??'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
function transposeChordToken(token,steps){const[main,bass]=token.split('/');
const tr=ch=>{const m=ch.match(/^([A-G])([#b])?(.*)$/);if(!m)return ch;
let[,r,a,rest]=m;let full=r+(a||'');if(FLAT_EQ[full])full=FLAT_EQ[full];
let i=NOTES.indexOf(full);if(i===-1)return ch;let ni=(i+steps)%12;if(ni<0)ni+=12;
return NOTES[ni]+(rest||'');};return bass?tr(main)+'/'+tr(bass):tr(main);}
function applyTransposeToText(text,steps){return text.replace(/\[([^\]]+)\]/g,(_,ch)=>'['+ch.split(/\s+/).filter(Boolean).map(t=>transposeChordToken(t,steps)).join(' ')+']');}
function renderLineTwoRow(l){let lyric='',segs=[],acc='',inch=false,len=0;
for(let i=0;i<l.length;i++){const ch=l[i];
if(ch==='['){inch=true;acc='';}
else if(ch===']'){inch=false;const pad=lyric.length-len;if(pad>0)segs.push({t:'s',l:pad});
segs.push({t:'c',x:acc});len+=(pad>0?pad:0)+acc.length;}
else if(inch){acc+=ch;}else{lyric+=ch;}}
let out='';for(const s of segs){out+=s.t==='s'?' '.repeat(s.l):`<span class="chord-strong">${esc(s.x)}</span>`;}
if(out.trim())return`<pre>${out}\n${esc(lyric)}</pre>`;if(lyric.trim())return`<pre>${esc(lyric)}</pre>`;return'<div style="height:8px"></div>';}
function classifySection(labelGuess){const t=(labelGuess||'').toLowerCase();
if(/chorus|coro/i.test(t))return{type:'chorus',title:labelGuess};
if(/bridge|puente/i.test(t))return{type:'bridge',title:labelGuess};
if(/verse|verso/i.test(t))return{type:'verse',title:labelGuess};
if(/intro/i.test(t))return{type:'intro',title:labelGuess};
if(/interlude/i.test(t))return{type:'interlude',title:labelGuess};
if(/outro/i.test(t))return{type:'outro',title:labelGuess};
return{type:'generic',title:labelGuess};}
function buildHeaderBadges(list){if(!list)return'';const t=list.split(',').map(s=>s.trim()).filter(Boolean);
const spans=t.map(x=>{const y=x.toUpperCase();const type=/I/.test(y)?'intro':/V/.test(y)?'verse':/C/.test(y)?'chorus':/B/.test(y)?'bridge':'generic';return`<span class="header-badge type-${type}">${esc(y)}</span>`});return`<div class="header-badges">${spans.join('')}</div>`;}
function parseMeta(text){const get=t=>{const m=text.match(new RegExp(`\\{${t}:\\s*(.*?)\\}`,'i'));return m?m[1].trim():null;};
return{title:get('title'),artist:get('artist'),key:get('key'),time:get('time'),tempo:get('tempo'),comment_box:get('comment_box'),section_list:get('section_list')};}
function renderHeader(meta){if(!meta)return'';let html='<div class="header-box">';
if(meta.title)html+=`<div class="title">${esc(meta.title)}</div>`;
let metas=[];if(meta.key)metas.push('Key: '+esc(meta.key));
if(meta.time)metas.push('Time: '+esc(meta.time));
if(meta.tempo)metas.push('Tempo: '+esc(meta.tempo));
if(metas.length)html+=`<div class="meta-row meta-inline"><span>${metas.join('</span><span>|</span><span>')}</span></div>`;
if(meta.comment_box)html+=`<div><span class="key-label">${esc(meta.comment_box)}</span></div>`;
if(meta.section_list)html+=buildHeaderBadges(meta.section_list);
html+='</div>';return html;}
function parseBody(text){const lines=text.split('\n'),parts=[];let sectionOpen=false;
const open=s=>{const c=classifySection(s);parts.push(`<div class="section-box ${c.type}"><div class="section-title">${esc(c.title)}</div>`);sectionOpen=true;};
const close=()=>{if(sectionOpen){parts.push('</div>');sectionOpen=false;}};
for(const raw of lines){const line=raw.trimEnd();
const kv=line.match(/^\{comment:\s*(.*?)\}$/i);if(kv){close();open(kv[1]);continue;}
if(line.trim()===''){parts.push('<div style="height:10px"></div>');continue;}
if(!sectionOpen)open('Section');parts.push(renderLineTwoRow(line));}
close();return parts.join('');}
function render(){const raw=document.getElementById('source').value||'';const m=raw.match(/\{key:\s*([A-G][#b]?m?)\s*\}/i);
songOriginalKey=m?m[1].replace(/\s+/g,''):null;
const sel=document.getElementById('keySelect').value;
transposeSteps=(sel&&songOriginalKey)?((NOTES.indexOf(sel.replace(/m$/,''))-NOTES.indexOf(songOriginalKey.replace(/m$/,''))+12)%12):0;
const meta=parseMeta(raw);const body=raw.replace(/\{[^}]+\}/g,'');
document.getElementById('outputArea').innerHTML=renderHeader(meta)+applyTransposeToText(parseBody(body),transposeSteps);}
document.getElementById('render').addEventListener('click',render);
document.getElementById('downloadCho').addEventListener('click',()=>{const t=document.getElementById('source').value;
const b=new Blob([t],{type:'text/plain;charset=utf-8'});const a=document.createElement('a');
a.href=URL.createObjectURL(b);a.download='song.cho';a.click();});
document.getElementById('exportPdf').addEventListener('click',()=>{const c=document.getElementById('outputArea').innerHTML;
const s=Array.from(document.querySelectorAll('style')).map(x=>x.outerHTML).join('\n');
const w=window.open('','_blank','width=900,height=1100');w.document.write(`<!doctype html><html><head><meta charset="utf-8">${s}</head><body><div class="viewer">${c}</div></body></html>`);w.document.close();w.print();});
(function init(){const s=document.getElementById('keySelect');
for(const k of MAJOR_KEYS){const o=document.createElement('option');o.value=k;o.textContent=k;s.appendChild(o);}
render();})();
</script>
</body>
</html>
