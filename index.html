<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ChordPro Viewer — Unified Screen/Print (Auto-Fit Letter)</title>
<style>
  :root{
    /* Colors */
    --page-bg:#f7f8fa; --card-bg:#ffffff; --muted:#6b7280; --accent:#1f6feb;

    /* Section tints (screen) */
    --generic-bg:#f8f9fa;
    --verse-bg:#f3fdf3;
    --chorus-bg:#eef6ff;
    --bridge-bg:#fffbea;
    --intro-bg:#f9f5ff;
    --interlude-bg:#faf5ff;
    --outro-bg:#f8f5f9;

    /* Accents for badges/lines */
    --generic-ac:#cfd8dc;
    --verse-ac:#81c784;
    --chorus-ac:#64b5f6;
    --bridge-ac:#f6d860;
    --intro-ac:#b39ddb;
    --interlude-ac:#ce93d8;
    --outro-ac:#b39ddb;

    /* Typography (auto-scaled by JS) */
    --lyric-size:16px;     /* normal */
    --chord-size:17px;     /* normal */
    --pre-line:1.6;        /* <pre> line-height */
    --section-title:16px;
    --meta-size:14px;
    --badge-font:12px;
    --title-size:32px;
    --subtitle-size:18px;

    /* Layout */
    --viewer-pad:24px;
    --column-gap:22mm;
    --header-gap:10px;
    --pre-margin:8px;
  }

  html,body{height:100%;margin:0;background:var(--page-bg);font-family:Georgia,"Times New Roman",serif;color:#111}
  .wrap{max-width:900px;margin:28px auto;padding:18px}
  header h1{margin:0 0 4px 0;font-size:28px;font-weight:800}
  header p{margin:0 0 18px 0;color:var(--muted);font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif}

  .card{background:var(--card-bg);border-radius:12px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,.08);margin-bottom:14px}
  textarea#source{width:100%;min-height:200px;border-radius:8px;padding:14px;border:1px solid #e1e4ea;font-family:monospace;font-size:14px;line-height:1.4}

  /* Controls */
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px}
  .btn{padding:8px 14px;border-radius:8px;cursor:pointer;font-family:system-ui;border:1px solid var(--accent);background:#fff;color:var(--accent)}
  .btn.primary{background:var(--accent);color:#fff}
  .controls .right{margin-left:auto;display:flex;align-items:center;gap:8px}
  select#keySelect{padding:8px;border-radius:8px;border:1px solid #bfc6d9;font-weight:600}

  /* Viewer */
  .viewer{background:#fff;border-radius:12px;padding:var(--viewer-pad);box-shadow:0 2px 6px rgba(0,0,0,.06)}
  .title{font-size:var(--title-size);font-weight:800;margin:0 0 4px 0}
  .subtitle{font-size:var(--subtitle-size);font-style:italic;color:var(--muted);margin:0 0 6px 0}
  .meta-row{font-size:var(--meta-size);color:var(--muted);font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif}

  /* Header box & header badges (same style/colors as sections) */
  .header-box{border:1px solid #dce2ea;border-radius:12px;padding:14px 16px;margin-bottom:12px}
  .header-content{text-align:center}
  .header-badges{
    display:flex;justify-content:center;align-items:center;flex-wrap:wrap;gap:10px;
    margin-top:var(--header-gap);
    break-inside:avoid;page-break-inside:avoid;
  }
  .header-badge{
    min-width:26px;height:26px;display:flex;align-items:center;justify-content:center;
    font-size:var(--badge-font);font-weight:800;border-radius:50%;border:2px solid var(--generic-ac);
    background:#fff;color:#111;padding:0 6px;
  }
  .header-badge.type-verse{border-color:var(--verse-ac)}
  .header-badge.type-prechorus{border-color:#ffb74d}
  .header-badge.type-chorus{border-color:var(--chorus-ac)}
  .header-badge.type-bridge{border-color:var(--bridge-ac)}
  .header-badge.type-intro{border-color:var(--intro-ac)}
  .header-badge.type-interlude{border-color:var(--interlude-ac)}
  .header-badge.type-outro{border-color:var(--outro-ac)}
  .header-badge.type-generic{border-color:var(--generic-ac)}

  /* Section boxes */
  .section-box{margin:22px 0;padding:18px 16px 16px;border-radius:12px;border:1px solid #dce2ea;position:relative;page-break-inside:avoid;break-inside:avoid;}
  .section-box.verse{background:var(--verse-bg)}
  .section-box.chorus{background:var(--chorus-bg)}
  .section-box.bridge{background:var(--bridge-bg)}
  .section-box.intro{background:var(--intro-bg)}
  .section-box.interlude{background:var(--interlude-bg)}
  .section-box.outro{background:var(--outro-bg)}
  .section-box.generic{background:var(--generic-bg)}

  .section-title{margin:8px 0 6px 0;font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;font-weight:700;color:#1f6feb;font-size:var(--section-title)}
  .section-badge{
    position:absolute;top:-14px;left:16px;min-width:26px;height:26px;border-radius:50%;
    background:#fff;border:2px solid var(--generic-ac);font-size:var(--badge-font);font-weight:800;
    display:flex;align-items:center;justify-content:center
  }
  .section-line{position:absolute;top:0;left:52px;right:16px;height:2px;background:var(--generic-ac);border-radius:3px}

  .section-box.verse .section-line, .section-box.verse .section-badge{border-color:var(--verse-ac);background:none}
  .section-box.chorus .section-line,.section-box.chorus .section-badge{border-color:var(--chorus-ac);background:none}
  .section-box.bridge .section-line,.section-box.bridge .section-badge{border-color:var(--bridge-ac);background:none}
  .section-box.intro .section-line,.section-box.intro .section-badge{border-color:var(--intro-ac);background:none}
  .section-box.interlude .section-line,.section-box.interlude .section-badge{border-color:var(--interlude-ac);background:none}
  .section-box.outro .section-line,.section-box.outro .section-badge{border-color:var(--outro-ac);background:none}

  /* Lyrics + chords (keep alignment) */
  pre{
    font-family:"Courier New", Courier, monospace;
    white-space:pre;          /* keep alignment */
    font-size:var(--lyric-size);
    line-height:var(--pre-line);
    margin:var(--pre-margin) 0;
    padding:6px 6px;
    background:#fff;border:1px solid #eee;border-radius:4px;
    break-inside:avoid;page-break-inside:avoid;
  }
  .chord-strong{font-weight:700;font-size:var(--chord-size)}

  /* Two-column mode (added/removed by JS auto-fit) */
  .viewer.two-col{column-count:2; column-gap:var(--column-gap); column-fill:auto;}
  .viewer.two-col .section-box,
  .viewer.two-col pre,
  .viewer.two-col .comment{break-inside:avoid; page-break-inside:avoid;}

  .comment{color:var(--muted);font-style:italic;margin:6px 0;padding-left:6px;border-left:2px solid #f0f0f0}
  .comment.box{border-left:4px solid #ccc;background:#f8f8f8;padding:8px;border-radius:6px;font-style:normal;color:#333}

  footer{margin-top:12px;color:var(--muted);font-size:13px;text-align:center}

  /* Print: we print from a dedicated window that includes only .viewer */
  @media print{
    @page{size:Letter; margin:12mm;}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ChordPro Viewer</h1>
      <p>Unified screen/print, auto-fit to Letter, 1–2 columns, preserves chord alignment.</p>
    </header>

    <div class="card">
      <label for="source" style="display:block;font-weight:600;margin-bottom:8px">ChordPro source</label>
      <textarea id="source" placeholder="{start_header}
{title: Tú Eres Digno de Gloria}
{artist: ICZ Worship}
{key: Am}
{time: 4/4}
{tempo: 126}
{comment_box: Key changed to: [Am]}
{section_list: I, V1, C, B }
{end_header}

{comment: Intro} 		
[F]   [G]   [F]   [G]
{comment: Verso}		                 
Hoy te alabamos Señ[F]or  [G]
Y declaramos que [F]Tú eres nuestro Di[G]os
Tu eres el Dios del am[F]or  [G] 
Y ya no somos escl[F]avos del tem[G]or
{comment_italic: Entra Bateria}		                 
Hoy te adoramos Señ[F]or  [G]
Y te cantamos con nu[F]estro coraz[G]ón
Te damos todo el hon[F]or   [G]
Sobre el cielo y la ti[F]erra
Tu eres Señ[G]or
{start_of_chorus}
Tu eres digno de gl[C]oria   [G]
Sobre toda la ti[Am]erra Tú eres Di[F]os
Tu eres digno de r[C]ecibir
Toda ad[G]oración
Todo [Am]el honor sea a [F]Tí
{end_of_chorus}
{comment: Interludio}	
[F]  [G]  [F]  [G]
{comment: Interludio 2}	
[Am]   [F]  [C]  [G]
{start_of_bridge}		
[Am]Eres digno
[F]Eres santo
[C]Eres Rey
De [G]toda creación
{end_of_bridge}"></textarea>

      <div class="controls no-print">
        <button id="render" class="btn primary">Render</button>
        <button id="downloadCho" class="btn">Download .cho</button>
        <button id="shareLink" class="btn">Share Link</button>
        <button id="exportPdf" class="btn">Export PDF / Print</button>

        <div class="right">
          <label for="keySelect" style="font-weight:600;margin-right:6px;color:#333">Select Key:</label>
          <select id="keySelect" aria-label="Transpose to key" title="Transpose to key">
            <option value="">(original)</option>
          </select>
        </div>
      </div>
    </div>

    <div id="outputArea" class="viewer card" aria-live="polite"></div>

    <footer>ChordPro Viewer — same look on screen and print; fits Letter page if possible.</footer>
  </div>

<script>
/* ================== Utilities ================== */
const MAJOR_KEYS=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const NOTES=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const FLAT_EQ={Db:'C#',Eb:'D#',Gb:'F#',Ab:'G#',Bb:'A#'};
let transposeSteps=0,songOriginalKey=null;

const esc=s=>(s??'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

/* Transpose */
function transposeChordToken(token,steps){
  const [main,bass]=token.split('/');
  const tr=ch=>{
    const m=ch.match(/^([A-G])([#b])?(.*)$/); if(!m) return ch;
    let[,r,a,rest]=m; let full=r+(a||''); if(FLAT_EQ[full]) full=FLAT_EQ[full];
    let i=NOTES.indexOf(full); if(i===-1) return ch;
    let ni=(i+steps)%12; if(ni<0) ni+=12;
    return NOTES[ni]+(rest||'');
  };
  return bass? tr(main)+'/'+tr(bass) : tr(main);
}
function applyTransposeToText(text,steps){
  return text.replace(/\[([^\]]+)\]/g,(_,ch)=>'['+ch.split(/\s+/).filter(Boolean).map(t=>transposeChordToken(t,steps)).join(' ')+']');
}

/* Two-row renderer (keeps alignment) */
function renderLineTwoRow(l){
  let lyric='',segs=[],acc='',inch=false,len=0;
  for(let i=0;i<l.length;i++){
    const ch=l[i];
    if(ch==='['){inch=true;acc='';}
    else if(ch===']'){
      inch=false; const pad=lyric.length-len; if(pad>0) segs.push({t:'s',l:pad});
      segs.push({t:'c',x:acc}); len+=(pad>0?pad:0)+acc.length;
    }else if(inch){acc+=ch;} else {lyric+=ch;}
  }
  let out=''; for(const s of segs){out += s.t==='s' ? ' '.repeat(s.l) : `<span class="chord-strong">${esc(s.x)}</span>`;}
  if(out.trim()) return `<pre>${out}\n${esc(lyric)}</pre>`;
  if(lyric.trim()) return `<pre>${esc(lyric)}</pre>`;
  return '<div style="height:8px"></div>';
}

/* Section type + badges */
function classifySection(labelGuess, tokenType=null){
  const t=(labelGuess||'').toLowerCase();
  if(tokenType==='chorus')return{type:'chorus',title:labelGuess||'Chorus'};
  if(tokenType==='bridge')return{type:'bridge',title:labelGuess||'Bridge'};
  if(tokenType==='verse') return{type:'verse',title:labelGuess||'Verse'};
  if(tokenType==='intro') return{type:'intro',title:labelGuess||'Intro'};
  if(tokenType==='prechorus')return{type:'prechorus',title:labelGuess||'Pre-Chorus'};
  if(tokenType==='interlude')return{type:'interlude',title:labelGuess||'Interlude'};
  if(tokenType==='outro') return{type:'outro',title:labelGuess||'Outro'};
  if(/(pre[\s-]?chor(us|o)|pre\s*coro)/i.test(t)) return{type:'prechorus',title:labelGuess||'Pre-Chorus'};
  if(/(chorus|coro|estribillo)/i.test(t)) return{type:'chorus',title:labelGuess||'Chorus'};
  if(/(bridge|puente)/i.test(t)) return{type:'bridge',title:labelGuess||'Bridge'};
  if(/(verse|verso|estrofa)/i.test(t)) return{type:'verse',title:labelGuess||'Verse'};
  if(/intro/i.test(t)) return{type:'intro',title:labelGuess||'Intro'};
  if(/(interlude|interludio)/i.test(t)) return{type:'interlude',title:labelGuess||'Interlude'};
  if(/(outro|final)/i.test(t)) return{type:'outro',title:labelGuess||'Outro'};
  return{type:'generic',title:labelGuess||'Section'};
}
function autoBadgeFrom(type,title){
  const m=(title||'').match(/(\d+)/), n=m?m[1]:'';
  switch(type){
    case'verse':return'V'+n; case'prechorus':return'Pc'; case'chorus':return'C';
    case'bridge':return'B'; case'intro':return'I'; case'interlude':return'It'; case'outro':return'O';
    default:return'';
  }
}

/* Header section_list → badges (AUTO detect types) */
function mapSectionToken(tok){
  if(!tok) return {type:'generic',text:''};
  const t=tok.trim().toUpperCase();
  if(t==='I'||t==='INTRO') return{type:'intro',text:'I'};
  if(/^V\d+$/.test(t)) return{type:'verse',text:t};
  if(t==='V') return{type:'verse',text:'V'};
  if(t==='C'||t==='CH') return{type:'chorus',text:'C'};
  if(t==='B'||t==='BR') return{type:'bridge',text:'B'};
  if(t==='PC'||t==='P'||t==='PRE'||t==='PCH') return{type:'prechorus',text:'Pc'};
  if(t==='IT'||t==='INT'||t==='INTERLUDE') return{type:'interlude',text:'It'};
  if(t==='O'||t==='OUTRO') return{type:'outro',text:'O'};
  return{type:'generic',text:t};
}
function buildHeaderBadges(sectionListStr){
  if(!sectionListStr) return '';
  const tokens=sectionListStr.split(',').map(s=>s.trim()).filter(Boolean);
  if(!tokens.length) return '';
  const spans=tokens.map(tok=>{
    const {type,text}=mapSectionToken(tok);
    return `<span class="header-badge type-${type}">${esc(text)}</span>`;
  });
  return `<div class="header-badges">${spans.join('')}</div>`;
}

/* Header parsing */
function splitHeaderBlock(raw){
  const start=raw.indexOf('{start_header}'), end=raw.indexOf('{end_header}');
  if(start!==-1 && end!==-1 && end>start){
    const before=raw.slice(0,start), header=raw.slice(start+15,end), after=raw.slice(end+13);
    return{header,body:before+after,hasExplicit:true};
  }
  return{header:null,body:raw,hasExplicit:false};
}
function parseMetaFields(text){
  const get=tag=>{ const m=text.match(new RegExp(`\\{${tag}:\\s*(.*?)\\}`,'i')); return m?m[1].trim():null; };
  return{
    title:get('title'),subtitle:get('subtitle'),artist:get('artist'),album:get('album'),
    key:get('key'),time:get('time'),tempo:get('tempo'),capo:get('capo'),
    comment:get('comment'),comment_box:get('comment_box'),section_list:get('section_list')
  };
}

/* Show selected Key in first [..] inside comment_box */
function getDisplayKeyForCommentBox(selValue){
  if(selValue && songOriginalKey) return selValue;
  return songOriginalKey || '';
}
function replaceSingleBracketWithDisplayKey(text,selValue){
  const k=getDisplayKeyForCommentBox(selValue);
  return k ? text.replace(/\[[^\]]*\]/,`[${k}]`) : text;
}

function renderHeaderRaw(headerText, metaFallback=null, selValue=''){
  let html='<div class="header-box"><div class="header-content">';
  let sectionListStr=null;

  const pushLine=s=>{ html += `<div>${s}</div>`; };

  if(headerText){
    const lines=headerText.replace(/\r/g,'').split('\n');
    for(const raw of lines){
      const line=raw.trim(); if(!line) continue;
      const kv=line.match(/^\{([^:}]+):\s*(.*?)\}$/);
      if(kv){
        const tag=kv[1].toLowerCase(), val=kv[2];
        if(tag==='title') pushLine(`<div class="title">${esc(val)}</div>`);
        else if(tag==='subtitle') pushLine(`<div class="subtitle">${esc(val)}</div>`);
        else if(tag==='artist') pushLine(`<div class="meta-row">Artist: ${esc(val)}</div>`);
        else if(tag==='album') pushLine(`<div class="meta-row">Album: ${esc(val)}</div>`);
        else if(['key','time','tempo','capo'].includes(tag)) pushLine(`<div class="meta-row">${tag[0].toUpperCase()+tag.slice(1)}: ${esc(val)}</div>`);
        else if(tag==='comment') pushLine(`<div class="meta-row">${esc(val)}</div>`);
        else if(tag==='comment_box'){
          const updated=replaceSingleBracketWithDisplayKey(val, selValue);
          pushLine(`<div style="display:inline-block;border:1px solid #d4d8e0;border-radius:8px;padding:6px 10px;margin:6px 0;background:#fafafa">${esc(updated)}</div>`);
        }else if(tag==='section_list'){
          sectionListStr=val; // rendered as badges below
        }else{
          pushLine(esc(line));
        }
      }else{ pushLine(esc(line)); }
    }
  }else if(metaFallback){
    if(metaFallback.title) pushLine(`<div class="title">${esc(metaFallback.title)}</div>`);
    if(metaFallback.subtitle) pushLine(`<div class="subtitle">${esc(metaFallback.subtitle)}</div>`);
    if(metaFallback.artist||metaFallback.album){
      let t=''; if(metaFallback.artist)t+=`Artist: ${esc(metaFallback.artist)}`;
      if(metaFallback.artist&&metaFallback.album)t+=' • ';
      if(metaFallback.album)t+=`Album: ${esc(metaFallback.album)}`;
      pushLine(`<div class="meta-row">${t}</div>`);
    }
    const extras=[];
    if(metaFallback.key)extras.push('Key: '+esc(metaFallback.key));
    if(metaFallback.time)extras.push('Time: '+esc(metaFallback.time));
    if(metaFallback.tempo)extras.push('Tempo: '+esc(metaFallback.tempo));
    if(metaFallback.capo)extras.push('Capo: '+esc(metaFallback.capo));
    if(extras.length) pushLine(`<div class="meta-row">${extras.join(' • ')}</div>`);
    if(metaFallback.comment) pushLine(`<div class="meta-row">${esc(metaFallback.comment)}</div>`);
    if(metaFallback.comment_box){
      const updated=replaceSingleBracketWithDisplayKey(metaFallback.comment_box, selValue);
      pushLine(`<div style="display:inline-block;border:1px solid #d4d8e0;border-radius:8px;padding:6px 10px;margin:6px 0;background:#fafafa">${esc(updated)}</div>`);
    }
    sectionListStr = metaFallback.section_list || null;
  }

  html+='</div>'; // header-content
  const badges=buildHeaderBadges(sectionListStr);
  if(badges) html+=badges;
  html+='</div>'; // header-box
  return html;
}

/* Body parser with section boxes */
function parseChordProBody(text){
  const lines=text.replace(/\r/g,'').split('\n'), parts=[];
  let sectionOpen=false, blockType=null;
  let nextNoBadge=false,nextNoLine=false,nextBadge=null,nextPlain=false;

  const openSection=(labelGuess,tokenType=null)=>{
    const cls=classifySection(labelGuess,tokenType), type=cls.type, title=cls.title;
    const hideBadge=nextPlain||nextNoBadge, hideLine=nextPlain||nextNoLine;
    const badgeText=nextPlain?'':(nextBadge!=null?nextBadge:autoBadgeFrom(type,title));
    parts.push(`<div class="section-box ${type}">`);
    if(!hideLine) parts.push('<div class="section-line"></div>');
    if(badgeText) parts.push(`<div class="section-badge">${esc(badgeText)}</div>`);
    parts.push(`<div class="section-title">${esc(title)}</div>`);
    nextNoBadge=false; nextNoLine=false; nextBadge=null; nextPlain=false; sectionOpen=true;
  };
  const closeSection=()=>{ if(sectionOpen){ parts.push('</div>'); sectionOpen=false; } };

  for(const raw of lines){
    const line=raw.trimEnd();

    const ov=line.match(/^\{badge:\s*(.*?)\}$/i); if(ov){nextBadge=ov[1];continue;}
    if(/^\{no_badge\}$/i.test(line)){nextNoBadge=true;continue;}
    if(/^\{no_line\}$/i.test(line)){nextNoLine=true;continue;}
    if(/^\{plain_section\}$/i.test(line)){nextPlain=true;continue;}

    const kv=line.match(/^\{([^:}]+):\s*(.*?)\}$/);
    if(kv){
      const tag=kv[1].toLowerCase(), val=kv[2];
      if(tag==='comment'){ closeSection(); openSection(val,null); }
      else if(tag==='comment_italic'){ if(!sectionOpen) openSection('Section',null); parts.push(`<div class="comment" style="font-style:italic">${esc(val)}</div>`); }
      else if(tag==='comment_box'){ if(!sectionOpen) openSection('Section',null); parts.push(`<div class="comment box">${esc(val)}</div>`); }
      continue;
    }

    const token=line.match(/^\{([a-zA-Z0-9_\-]+)\}$/);
    if(token){
      const t=token[1].toLowerCase();
      if(['start_of_chorus','soc','start_chorus'].includes(t)){ closeSection(); blockType='chorus'; openSection('Chorus','chorus'); continue; }
      if(['start_of_bridge','start_bridge'].includes(t)){ closeSection(); blockType='bridge'; openSection('Bridge','bridge'); continue; }
      if(['verse','verso','estrofa'].includes(t)){ closeSection(); blockType=null; openSection('Verse','verse'); continue; }
      if(['intro'].includes(t)){ closeSection(); blockType=null; openSection('Intro','intro'); continue; }
      if(['interlude'].includes(t)){ closeSection(); blockType=null; openSection('Interlude','interlude'); continue; }
      if(['outro'].includes(t)){ close Section(); blockType=null; openSection('Outro','outro'); continue; }
      if(['prechorus','pre_chorus'].includes(t)){ closeSection(); blockType=null; openSection('Pre-Chorus','prechorus'); continue; }
      if(['start_of_tab','start_tab'].includes(t)){ if(!sectionOpen) openSection('Tab','generic'); blockType='tab'; continue; }
      if(['end_of_chorus','eoc','end_chorus','end_of_bridge','end_bridge','end_of_tab','end_tab','end_of_comment','end_comment'].includes(t)){ blockType=null; closeSection(); continue; }
      continue;
    }

    if(line.trim()===''){ parts.push('<div style="height:10px"></div>'); continue; }
    if(!sectionOpen) openSection('Section',null);
    if(blockType==='tab') parts.push(`<pre>${esc(line)}</pre>`); else parts.push(renderLineTwoRow(line));
  }

  closeSection();
  return parts.join('');
}

/* Transpose helpers */
function normalizeKey(k){ if(!k) return null; const m=k.trim().match(/^([A-G])([#b]?)(m?)$/i); if(!m) return null;
  let r=m[1].toUpperCase(), a=m[2]||'', min=m[3]?'m':''; let full=r+a; if(FLAT_EQ[full]) full=FLAT_EQ[full]; return full+min; }
function computeSemitoneDiff(a,b){ const nf=normalizeKey(a), nt=normalizeKey(b); if(!nf||!nt) return 0;
  const i1=NOTES.indexOf(nf.replace(/m$/,'')), i2=NOTES.indexOf(nt.replace(/m$/,'')); let d=i2-i1; if(d>6)d-=12; if(d<-6)d+=12; return d; }
function fillKeySelect(){
  const s=document.getElementById('keySelect'); s.innerHTML='<option value="">(original)</option>';
  for(const k of MAJOR_KEYS){ const o=document.createElement('option'); o.value=k; o.textContent=k; s.appendChild(o); }
  const sep=document.createElement('option'); sep.disabled=true; sep.textContent='── minor keys ──'; s.appendChild(sep);
  for(const k of MAJOR_KEYS){ const o=document.createElement('option'); o.value=k+'m'; o.textContent=k+'m'; s.appendChild(o); }
}

/* ========== Auto-Fit Engine (Option B: Auto 1→2 col; min sizes 13/14) ========== */
function setVars({lyric, chord, line, sectionTitle, meta, badge, title, subtitle, viewerPad}){
  const v=document.getElementById('outputArea');
  v.style.setProperty('--lyric-size', lyric+'px');
  v.style.setProperty('--chord-size', chord+'px');
  v.style.setProperty('--pre-line', line);
  v.style.setProperty('--section-title', sectionTitle+'px');
  v.style.setProperty('--meta-size', meta+'px');
  v.style.setProperty('--badge-font', badge+'px');
  v.style.setProperty('--title-size', title+'px');
  v.style.setProperty('--subtitle-size', subtitle+'px');
  v.style.setProperty('--viewer-pad', viewerPad+'px');
}

function measureFitsViewport(pct=0.92){
  const v=document.getElementById('outputArea');
  const available = window.innerHeight * pct;
  return v.scrollHeight <= available;
}

function applyColumns(twoCols){
  const v=document.getElementById('outputArea');
  twoCols ? v.classList.add('two-col') : v.classList.remove('two-col');
}

function autoFit(){
  // Start: normal sizes
  applyColumns(false);
  setVars({lyric:16, chord:17, line:1.6, sectionTitle:16, meta:14, badge:12, title:32, subtitle:18, viewerPad:24});

  // If fits in 1 col → done
  if(measureFitsViewport()) return;

  // Try 2 cols
  applyColumns(true);
  if(measureFitsViewport()) return;

  // Downscale gently to min (Option B: lyrics>=13, chords>=14)
  let lyric=16, chord=17, line=1.58, sectionTitle=15, meta=13, badge=12, title=30, subtitle=17, viewerPad=20;
  for(let step=0; step<8; step++){
    lyric=Math.max(13, lyric-1);
    chord=Math.max(14, chord-1);
    line =Math.max(1.46, (line-0.02));
    sectionTitle=Math.max(14, sectionTitle-1);
    meta=Math.max(12, meta-1);
    badge=Math.max(11, badge-1);
    title=Math.max(26, title-1);
    subtitle=Math.max(16, subtitle-1);
    viewerPad=Math.max(12, viewerPad-2);
    setVars({lyric, chord, line, sectionTitle, meta, badge, title, subtitle, viewerPad});
    if(measureFitsViewport()) return;
  }
  // If still long → it will overflow (rare, very long songs).
}

/* ================== Render pipeline ================== */
function render(){
  const raw=document.getElementById('source').value||'';

  // detect original key
  const m=raw.match(/\{key:\s*([A-G][#b]?m?)\s*\}/i);
  songOriginalKey = m ? m[1].replace(/\s+/g,'') : null;

  const sel=document.getElementById('keySelect').value;
  transposeSteps = (sel && songOriginalKey) ? computeSemitoneDiff(songOriginalKey, sel) : 0;

  const {header,body,hasExplicit}=splitHeaderBlock(raw);
  const metaFallback=parseMetaFields(raw);

  const headerHtml = renderHeaderRaw(header, hasExplicit ? null : metaFallback, sel);
  const bodyT = applyTransposeToText(body, transposeSteps);
  const bodyHtml = parseChordProBody(bodyT);

  document.getElementById('outputArea').innerHTML = headerHtml + bodyHtml;

  // Auto-fit after content is in DOM
  requestAnimationFrame(()=>autoFit());
}

/* ================== UI wiring ================== */
document.getElementById('render').addEventListener('click', render);
document.getElementById('keySelect').addEventListener('change', render);
window.addEventListener('resize', ()=>requestAnimationFrame(()=>autoFit()));

document.getElementById('downloadCho').addEventListener('click',()=>{
  const text=document.getElementById('source').value||''; const blob=new Blob([text],{type:'text/plain;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  let name='song'; const m=text.match(/\{title:\s*(.+?)\}/i); if(m) name=m[1].trim().replace(/[^\w\- ]+/g,'').replace(/\s+/g,'_');
  a.download=name+'.cho'; a.click(); URL.revokeObjectURL(a.href);
});
document.getElementById('shareLink').addEventListener('click',async()=>{
  const text=document.getElementById('source').value||''; const enc=btoa(unescape(encodeURIComponent(text)));
  const url=location.origin+location.pathname+'?song='+enc;
  try{ await navigator.clipboard.writeText(url); alert('Link copied to clipboard'); }
  catch(e){ prompt('Copy this link:',url); }
});

/* ========== Export PDF / Print — ONLY the rendered viewer, with auto-fit in print window ========== */
document.getElementById('exportPdf').addEventListener('click',()=>{
  const viewer = document.getElementById('outputArea');
  const content = viewer.innerHTML;

  // Collect style tags from the main document so print window looks identical
  const styles = Array.from(document.querySelectorAll('style')).map(s => s.outerHTML).join('\n');

  // Snapshot current CSS variables and classes from .viewer
  const viewerClass = viewer.className;                 // may contain 'two-col'
  const inlineVars  = viewer.getAttribute('style')||''; // contains --lyric-size etc.

  const w = window.open('', '_blank', 'width=900,height=1100');

  w.document.write(`
    <!doctype html>
    <html>
      <head>
        <meta charset="utf-8">
        <title>Print Song</title>
        ${styles}
        <style>
          body{margin:0;background:#fff;}
          .print-wrap{margin:0;}
          @page{size:Letter; margin:12mm;}
          /* Ensure identical look; .viewer rules already included above */
        </style>
      </head>
      <body>
        <div class="print-wrap">
          <div id="printViewer" class="${viewerClass}" style="${inlineVars}">
            ${content}
          </div>
        </div>

        <script>
          // Auto-fit inside print window too (Option B: auto 1→2 columns; min sizes 13/14)
          function setVar(el,name,val){ el.style.setProperty(name,val); }
          function measureFits(pct){
            const el = document.getElementById('printViewer');
            const available = window.innerHeight * (pct||0.92);
            return el.scrollHeight <= available;
          }
          function toggleCols(on){
            const v=document.getElementById('printViewer');
            on ? v.classList.add('two-col') : v.classList.remove('two-col');
          }
          function getVarPx(el,name){ const cs=getComputedStyle(el).getPropertyValue(name).trim(); return parseFloat(cs); }

          function autoFitPrint(){
            const v=document.getElementById('printViewer');

            // Start from whatever vars came from the main window (keeps on-screen auto-fit),
            // but we still try to refine for the print window viewport.
            toggleCols(false);
            if(measureFits(0.96)) return;

            toggleCols(true);
            if(measureFits(0.96)) return;

            // Read current values, then scale down to min (lyrics>=13, chords>=14)
            let lyric = Math.max(13, getVarPx(v,'--lyric-size') || 16);
            let chord = Math.max(14, getVarPx(v,'--chord-size') || 17);
            let line  = Math.max(1.46, parseFloat(getComputedStyle(v).getPropertyValue('--pre-line')) || 1.6);
            let sectionTitle = Math.max(14, getVarPx(v,'--section-title') || 16);
            let meta  = Math.max(12, getVarPx(v,'--meta-size') || 14);
            let badge = Math.max(11, getVarPx(v,'--badge-font') || 12);
            let title = Math.max(26, getVarPx(v,'--title-size') || 32);
            let subtitle = Math.max(16, getVarPx(v,'--subtitle-size') || 18);
            let pad = Math.max(12, getVarPx(v,'--viewer-pad') || 24);

            for(let i=0;i<8;i++){
              if(measureFits(0.96)) break;
              lyric = Math.max(13, lyric-1);
              chord = Math.max(14, chord-1);
              line  = Math.max(1.46, line-0.02);
              sectionTitle = Math.max(14, sectionTitle-1);
              meta  = Math.max(12, meta-1);
              badge = Math.max(11, badge-1);
              title = Math.max(26, title-1);
              subtitle = Math.max(16, subtitle-1);
              pad = Math.max(12, pad-2);

              setVar(v,'--lyric-size', lyric+'px');
              setVar(v,'--chord-size', chord+'px');
              setVar(v,'--pre-line', line);
              setVar(v,'--section-title', sectionTitle+'px');
              setVar(v,'--meta-size', meta+'px');
              setVar(v,'--badge-font', badge+'px');
              setVar(v,'--title-size', title+'px');
              setVar(v,'--subtitle-size', subtitle+'px');
              setVar(v,'--viewer-pad', pad+'px');
            }
          }

          window.addEventListener('load', ()=>{
            // Give layout a tick, then auto-fit and print
            setTimeout(()=>{
              autoFitPrint();
              setTimeout(()=>{ window.print(); window.close(); }, 150);
            }, 50);
          });
        <\/script>
      </body>
    </html>
  `);

  w.document.close();
});

/* Init key options + optional ?song= */
(function init(){
  const s=document.getElementById('keySelect');
  s.innerHTML='<option value="">(original)</option>';
  for(const k of MAJOR_KEYS){ const o=document.createElement('option'); o.value=k; o.textContent=k; s.appendChild(o); }
  const sep=document.createElement('option'); sep.disabled=true; sep.textContent='── minor keys ──'; s.appendChild(sep);
  for(const k of MAJOR_KEYS){ const o=document.createElement('option'); o.value=k+'m'; o.textContent=k+'m'; s.appendChild(o); }

  const params=new URLSearchParams(location.search);
  if(params.has('song')){
    try{ document.getElementById('source').value=decodeURIComponent(escape(atob(params.get('song')))); }
    catch(e){ document.getElementById('source').value=params.get('song'); }
  }
  render();
})();
</script>
</body>
</html>
